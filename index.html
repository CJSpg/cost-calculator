<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯é€±é£²é£Ÿè¦åŠƒè¡¨</title>
    
    <!-- LINE Auto Redirect Script -->
    <script>
        (function() {
            if (/Line/i.test(navigator.userAgent)) {
                // å¦‚æœç¶²å€æ²’æœ‰ openExternalBrowser åƒæ•¸ï¼Œå‰‡åŠ ä¸Šä¸¦é‡æ•´ï¼Œå˜—è©¦è§¸ç™¼ LINE å¤–éƒ¨é–‹å•Ÿæ©Ÿåˆ¶
                if (location.search.indexOf('openExternalBrowser=1') === -1) {
                    var url = new URL(location.href);
                    url.searchParams.append('openExternalBrowser', '1');
                    window.location.replace(url.href);
                }
            }
        })();
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Init theme immediately to prevent flash
        if (localStorage.getItem('theme') === 'light') {
            document.documentElement.classList.remove('dark');
        } else {
            document.documentElement.classList.add('dark');
        }

        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#8B5CF6', // Violet 500
                        secondary: '#EC4899', // Pink 500
                        dark: '#0F172A', // Slate 900
                        surface: '#1E293B', // Slate 800
                        light: '#F8FAFC', // Slate 50
                        'surface-light': '#FFFFFF', // White
                    }
                }
            }
        }
    </script>

    <!-- html2canvas for Image Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Vue.js 3 -->
    <script type="importmap">
        {
          "imports": {
            "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js",
            "firebase/app": "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"
          }
        }
    </script>
    
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        .list-move, .list-enter-active, .list-leave-active { transition: all 0.5s ease; }
        .list-enter-from, .list-leave-to { opacity: 0; transform: translateX(30px); }
        .list-leave-active { position: absolute; width: 100%; }
        
        .modal-enter-active, .modal-leave-active { transition: opacity 0.2s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }

        @media print {
            body { background: white; color: black; }
            .no-print, header, .edit-controls { display: none !important; }
            .print-only { display: block !important; }
            #capture-area { padding: 0; background: white; }
            .text-white { color: black !important; }
            .text-slate-300, .text-slate-400, .text-slate-500 { color: #555 !important; }
        }
    </style>
</head>
<body class="bg-light dark:bg-dark text-slate-800 dark:text-slate-200 min-h-screen font-sans transition-colors duration-300">

<div id="app" class="flex flex-col min-h-screen">
    
    <!-- Hidden File Input for Import -->
    <input type="file" ref="fileInput" class="hidden" accept=".json" @change="handleImportFile">

    <!-- Header -->
    <header class="bg-surface-light dark:bg-surface border-b border-slate-200 dark:border-slate-700 shadow-sm sticky top-0 z-40 no-print transition-colors duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <svg class="w-8 h-8 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                <h1 class="text-xl font-bold tracking-wide text-slate-900 dark:text-white hidden sm:block">Weekly<span class="text-primary">Plan</span></h1>
            </div>
            
            <div class="flex items-center gap-2">
                <!-- Group: File Operations -->
                <div class="flex items-center bg-slate-100 dark:bg-slate-700 rounded-lg p-1">
                    <button 
                        @click="exportData" 
                        class="h-9 px-3 rounded-md hover:bg-white dark:hover:bg-slate-600 text-slate-600 dark:text-slate-300 transition-all text-xs sm:text-sm font-medium flex items-center gap-1.5"
                        title="ä¸‹è¼‰å‚™ä»½æª”æ¡ˆ (JSON)"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        <span class="hidden sm:inline">æª”æ¡ˆ</span>
                    </button>
                    
                    <div class="w-px h-4 bg-slate-300 dark:bg-slate-600 mx-1"></div>

                    <button 
                        @click="triggerImport" 
                        class="h-9 px-3 rounded-md hover:bg-white dark:hover:bg-slate-600 text-slate-600 dark:text-slate-300 transition-all text-xs sm:text-sm font-medium flex items-center gap-1.5"
                        title="åŒ¯å…¥å‚™ä»½æª”æ¡ˆ (JSON)"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m-4 4v12"></path></svg>
                        <span class="hidden sm:inline">åŒ¯å…¥</span>
                    </button>
                </div>

                <!-- Group: Cloud Sync -->
                <button 
                    @click="openCloudModal"
                    class="h-11 px-3 rounded-lg bg-primary/10 hover:bg-primary/20 text-primary dark:text-primary-300 border border-primary/20 transition-all text-xs sm:text-sm font-bold flex items-center gap-1.5"
                    title="é›²ç«¯åŒæ­¥/æ›è£ç½®"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    <span class="hidden sm:inline">é›²ç«¯å­˜å–</span>
                </button>

                <!-- Group: System -->
                <div class="flex items-center bg-slate-100 dark:bg-slate-700 rounded-lg p-1">
                     <button 
                        @click="clearAllData" 
                        class="h-9 px-3 rounded-md hover:bg-red-50 dark:hover:bg-red-900/30 text-slate-500 hover:text-red-600 dark:text-slate-400 dark:hover:text-red-400 transition-all text-xs sm:text-sm font-medium flex items-center gap-1.5"
                        title="å…¨éƒ¨æ¸…é™¤"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>

                    <div class="w-px h-4 bg-slate-300 dark:bg-slate-600 mx-1"></div>

                    <button 
                        @click="toggleTheme" 
                        class="h-9 px-3 rounded-md hover:bg-white dark:hover:bg-slate-600 text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white transition-colors"
                        title="åˆ‡æ›æ·±è‰²/æ·ºè‰²æ¨¡å¼"
                    >
                        <svg v-if="isDark" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                        <svg v-else class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Content -->
    <main class="flex-grow p-4 sm:p-6 max-w-7xl mx-auto w-full relative z-0">

        <!-- Day Navigation -->
        <div class="flex overflow-x-auto pb-2 gap-2 no-print custom-scrollbar">
            <button 
                v-for="day in weekDays" 
                :key="day"
                @click="currentDay = day"
                type="button"
                :class="[
                    'flex-shrink-0 px-6 py-3 rounded-xl font-bold text-sm transition-all duration-200 border border-transparent',
                    currentDay === day 
                        ? 'bg-primary text-white shadow-lg shadow-primary/25 scale-105' 
                        : 'bg-white dark:bg-surface text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 border-slate-200 dark:border-slate-700'
                ]"
            >
                {{ day }}
            </button>
        </div>

        <!-- Controls & Current Day Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-white dark:bg-surface p-4 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm mt-6 transition-colors duration-300">
            <div>
                <h2 class="text-2xl font-bold text-slate-800 dark:text-white">{{ currentDay }} <span class="text-slate-500 dark:text-slate-500 text-base font-normal">è¡Œç¨‹è¦åŠƒ</span></h2>
                <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">å®‰æ’ä»Šæ—¥çš„é£²é£Ÿæ™‚æ®µèˆ‡æ•¸é‡</p>
            </div>
            <div class="flex gap-2">
                <button 
                    @click="openCopyModal"
                    type="button"
                    class="flex items-center gap-2 px-4 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-700 dark:text-white transition-colors text-sm font-medium"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"></path></svg>
                    è¤‡è£½è¡Œç¨‹åˆ°åˆ¥å¤©
                </button>
            </div>
        </div>

        <!-- Timeline / Blocks for Current Day -->
        <div class="relative min-h-[300px] mt-6">
            <transition-group name="list" tag="div" class="space-y-6">
                <time-block-section 
                    v-for="block in sortedCurrentDayLog" 
                    :key="block.id"
                    :block="block"
                    :products="products"
                    @delete-block="removeTimeBlock(block.id)"
                    @add-item="addItemToBlock(block)"
                    @remove-item="(idx) => removeItemFromBlock(block, idx)"
                    @open-picker="(item) => openPicker(item)"
                ></time-block-section>
            </transition-group>

            <!-- Add Time Block Button -->
            <button 
                @click="addTimeBlock"
                type="button"
                class="w-full mt-6 bg-slate-50 dark:bg-dark border-2 border-dashed border-slate-300 dark:border-slate-600 hover:border-primary hover:text-primary text-slate-400 dark:text-slate-500 rounded-xl p-6 flex flex-col items-center justify-center gap-2 transition-all group"
            >
                <svg class="w-8 h-8 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                <span class="font-medium">æ–°å¢æ™‚æ®µ</span>
            </button>
        </div>

        <!-- Weekly Summary Section (Print Area Wrapper) -->
        <div class="mt-12 rounded-xl overflow-hidden shadow-xl mb-12 border border-slate-200 dark:border-slate-700 bg-white dark:bg-surface transition-colors duration-300">
            
            <!-- Actual Capture Target (Content) -->
            <div id="capture-area" class="bg-white dark:bg-surface transition-colors duration-300 pb-2">
                <!-- Summary Header -->
                <div class="px-6 py-4 flex justify-between items-center transition-colors duration-300 bg-primary dark:bg-slate-700">
                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        ç¸½æ¸…å–®
                    </h3>
                    <div class="text-xs text-white/80 no-print">è‡ªå‹•çµ±è¨ˆæ‰€æœ‰å¤©æ•¸</div>
                </div>
                
                <!-- Summary Content -->
                <div class="p-6">
                    <div v-if="Object.keys(weeklySummary).length === 0" class="text-center text-slate-400 py-8">
                        å°šæœªå®‰æ’ä»»ä½•è¡Œç¨‹ï¼Œè«‹å…ˆè‡³ä¸Šæ–¹å¡«å¯«æ¯æ—¥è¦åŠƒã€‚
                    </div>
                    <div v-else class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div v-for="(item, key) in weeklySummary" :key="key" class="flex justify-between items-start gap-4 border-b border-slate-200 dark:border-slate-700 pb-2">
                            <!-- Left: Name -->
                            <div class="flex-1 min-w-0">
                                <div class="font-bold text-lg text-slate-800 dark:text-slate-200 break-words leading-tight">{{ item.name }}</div>
                            </div>
                            
                            <!-- Right: Quantities -->
                            <div class="flex flex-col items-end shrink-0">
                                <!-- Consumption Qty -->
                                <span class="font-mono text-xl font-bold px-2 rounded bg-purple-50 text-primary dark:bg-primary/20 dark:text-purple-300 whitespace-nowrap flex items-center">
                                    {{ item.totalQuantity }} <span class="text-xs text-slate-500 dark:text-slate-400 ml-1">{{ item.unit }}</span>
                                    <span v-if="item.packSize && item.packageUnit" class="text-xs text-slate-500 dark:text-slate-400 ml-1">
                                        ({{ item.packSize }}{{ item.unit }}/{{ item.packageUnit }})
                                    </span>
                                </span>
                                
                                <!-- Purchase Qty -->
                                <span v-if="item.packSize && item.packageUnit" class="text-xs font-bold text-slate-500 dark:text-slate-400 mt-1">
                                    â‰ˆ {{ Math.ceil(item.totalQuantity / item.packSize) }} {{ item.packageUnit }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Itinerary Section -->
                <div v-if="hasAnyData" class="mt-4 pt-8 px-6 border-t-2 border-dashed border-slate-200 dark:border-slate-700">
                    <div class="flex items-center justify-center mb-6">
                        <span class="px-4 py-1 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 text-sm font-bold tracking-wider">
                            æ¯é€±è©³ç´°è¡Œç¨‹
                        </span>
                    </div>

                    <div class="space-y-8">
                        <div v-for="day in weekDays" :key="day">
                            <div v-if="weeklyPlan[day] && weeklyPlan[day].length > 0">
                                <h4 class="text-lg font-bold text-primary mb-3 border-l-4 border-primary pl-3 flex items-center">
                                    {{ day }}
                                </h4>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                    <div 
                                        v-for="block in getSortedBlocks(day)" 
                                        :key="block.id"
                                        class="bg-slate-50 dark:bg-slate-800/50 rounded-lg p-3 border border-slate-200 dark:border-slate-700/50"
                                    >
                                        <div class="flex items-center gap-2 mb-2 border-b border-slate-200 dark:border-slate-700 pb-2">
                                            <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                            <span class="font-mono font-bold text-slate-700 dark:text-slate-200">{{ block.time }}</span>
                                            <!-- Label display in Summary -->
                                            <span v-if="block.label" class="text-xs px-1.5 py-0.5 rounded text-slate-600 dark:text-slate-300 ml-auto truncate max-w-[80px]">
                                                {{ block.label }}
                                            </span>
                                        </div>
                                        <ul class="space-y-1">
                                            <li v-for="item in block.items" :key="item.productId" class="text-sm flex justify-between">
                                                <span class="text-slate-600 dark:text-slate-300 truncate pr-2">
                                                    {{ getProductName(item.productId) || item.unknownName || 'æœªå‘½å' }}
                                                </span>
                                                <span class="font-medium text-slate-800 dark:text-slate-200 whitespace-nowrap">
                                                    x {{ item.quantity }} {{ getProductUnit(item.productId) }}
                                                </span>
                                            </li>
                                            <li v-if="block.items.length === 0" class="text-xs text-slate-400 italic">ç„¡é …ç›®</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary Remark Section -->
                <div class="px-6 py-4 mt-4">
                     <label class="block text-sm font-bold text-slate-500 dark:text-slate-400 mb-2">
                        å‚™è¨»ï¼š
                    </label>
                    <textarea 
                        v-model="summaryNote" 
                        rows="3" 
                        class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-3 text-sm text-slate-800 dark:text-white focus:outline-none focus:ring-1 focus:ring-primary resize-none placeholder-slate-400"
                        placeholder="åœ¨æ­¤è¼¸å…¥æ³¨æ„äº‹é …..."
                    ></textarea>
                </div>
            </div>

            <!-- Controls (Outside capture area) -->
            <div class="bg-slate-50 dark:bg-slate-800/50 px-6 py-4 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3 no-print">
                <button @click="downloadImage" type="button" class="px-4 py-2 bg-slate-800 dark:bg-slate-600 text-white rounded-lg hover:bg-slate-700 dark:hover:bg-slate-500 transition-colors flex items-center gap-2 text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    ä¸‹è¼‰åœ–ç‰‡
                </button>
            </div>
        </div>

    </main>

    <!-- CLOUD SYNC MODAL -->
    <transition name="modal">
        <div v-if="cloudModal.isOpen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div @click="closeCloudModal" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
            <div class="bg-white dark:bg-surface rounded-xl border border-slate-200 dark:border-slate-600 shadow-2xl max-w-md w-full relative z-10 overflow-hidden transition-colors duration-300">
                
                <div class="bg-slate-50 dark:bg-slate-800 p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                    <h3 class="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                        <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                        é›²ç«¯å­˜å–
                    </h3>
                    <button @click="closeCloudModal" class="text-slate-400 hover:text-slate-600 dark:hover:text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <div class="p-6">
                    <!-- Tabs -->
                    <div class="flex border-b border-slate-200 dark:border-slate-700 mb-6">
                        <button 
                            @click="cloudModal.mode = 'save'" 
                            :class="['flex-1 pb-2 text-sm font-bold border-b-2 transition-colors', cloudModal.mode === 'save' ? 'border-primary text-primary' : 'border-transparent text-slate-400 hover:text-slate-600 dark:hover:text-slate-300']"
                        >
                            å„²å­˜
                        </button>
                        <button 
                            @click="cloudModal.mode = 'load'" 
                            :class="['flex-1 pb-2 text-sm font-bold border-b-2 transition-colors', cloudModal.mode === 'load' ? 'border-primary text-primary' : 'border-transparent text-slate-400 hover:text-slate-600 dark:hover:text-slate-300']"
                        >
                            è®€å–
                        </button>
                         <button 
                            @click="cloudModal.mode = 'templates'; fetchTemplates()" 
                            :class="['flex-1 pb-2 text-sm font-bold border-b-2 transition-colors', cloudModal.mode === 'templates' ? 'border-primary text-primary' : 'border-transparent text-slate-400 hover:text-slate-600 dark:hover:text-slate-300']"
                        >
                            å®˜æ–¹æ¨¡æ¿
                        </button>
                    </div>

                    <!-- SAVE Mode -->
                    <div v-if="cloudModal.mode === 'save'" class="space-y-4">
                        <p class="text-sm text-slate-600 dark:text-slate-300">
                            å°‡æ‚¨ç›®å‰çš„é€±è¨ˆç•«å„²å­˜åˆ°é›²ç«¯ï¼Œç³»çµ±æœƒç”¢ç”Ÿä¸€çµ„ <span class="font-bold text-primary">å”¯ä¸€ä»£ç¢¼</span>ã€‚
                        </p>
                        
                        <div v-if="cloudModal.savedId" class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4 text-center">
                            <div class="text-sm text-green-600 dark:text-green-400 mb-1">ä¸Šå‚³æˆåŠŸï¼æ‚¨çš„ä¸‹è¼‰ä»£ç¢¼æ˜¯ï¼š</div>
                            <div class="text-3xl font-mono font-bold text-slate-800 dark:text-white my-2 tracking-widest select-all">{{ cloudModal.savedId }}</div>
                            <div class="text-xs text-slate-500 dark:text-slate-400">è«‹è¨˜ä¸‹æ­¤ä»£ç¢¼ï¼Œåœ¨å…¶ä»–è£ç½®è¼¸å…¥å³å¯é‚„åŸè³‡æ–™ã€‚</div>
                        </div>

                        <button 
                            v-else
                            @click="saveToCloud" 
                            :disabled="cloudModal.loading"
                            class="w-full py-3 bg-primary hover:bg-violet-600 text-white rounded-lg font-bold shadow-lg shadow-primary/30 transition-all flex justify-center items-center gap-2"
                        >
                            <svg v-if="cloudModal.loading" class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            <span v-else>å„²å­˜ä¸¦å–å¾—ä»£ç¢¼</span>
                        </button>
                    </div>

                    <!-- LOAD Mode -->
                    <div v-if="cloudModal.mode === 'load'" class="space-y-4">
                         <p class="text-sm text-slate-600 dark:text-slate-300">
                            è¼¸å…¥æ‚¨çš„ <span class="font-bold text-primary">ä»£ç¢¼</span> ä»¥é‚„åŸè³‡æ–™ã€‚
                            <br><span class="text-xs text-red-500">æ³¨æ„ï¼šé€™å°‡æœƒè¦†è“‹æ‚¨ç›®å‰çš„ç•«é¢ä¸Šçš„è¨­å®šã€‚</span>
                        </p>

                        <input 
                            v-model="cloudModal.inputId" 
                            type="text" 
                            placeholder="åœ¨æ­¤è¼¸å…¥ä»£ç¢¼..." 
                            class="w-full text-center text-xl tracking-widest font-mono uppercase bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:outline-none dark:text-white"
                        >

                        <button 
                            @click="loadFromCloud" 
                            :disabled="cloudModal.loading || !cloudModal.inputId"
                            class="w-full py-3 bg-slate-800 hover:bg-slate-700 dark:bg-white dark:hover:bg-slate-200 text-white dark:text-slate-900 rounded-lg font-bold transition-all flex justify-center items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <svg v-if="cloudModal.loading" class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            <span v-else>è®€å–</span>
                        </button>
                    </div>

                    <!-- TEMPLATES Mode -->
                    <div v-if="cloudModal.mode === 'templates'" class="space-y-4">
                        <p class="text-sm text-slate-600 dark:text-slate-300">
                            é¸æ“‡å®˜æ–¹æä¾›çš„ <span class="font-bold text-primary">é è¨­è¡Œç¨‹</span> å¿«é€Ÿé–‹å§‹ã€‚
                            <br><span class="text-xs text-red-500">æ³¨æ„ï¼šé€™å°‡æœƒè¦†è“‹æ‚¨ç›®å‰çš„ç•«é¢ä¸Šçš„è¨­å®šã€‚</span>
                        </p>

                        <div class="space-y-2 max-h-[300px] overflow-y-auto custom-scrollbar pr-1">
                            <div v-if="templates.length === 0 && !cloudModal.loading" class="text-center py-6 text-slate-400">
                                æš«ç„¡å®˜æ–¹æ¨¡æ¿
                            </div>
                            <div v-if="cloudModal.loading" class="text-center py-6 text-slate-400">
                                <svg class="animate-spin h-6 w-6 mx-auto text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            </div>
                            
                            <button 
                                v-for="tpl in templates" 
                                :key="tpl.id"
                                @click="selectTemplate(tpl)"
                                class="w-full text-left bg-slate-50 dark:bg-slate-700/50 hover:bg-slate-100 dark:hover:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg p-3 transition-colors group"
                            >
                                <div class="flex justify-between items-start">
                                    <div class="font-bold text-slate-800 dark:text-white group-hover:text-primary transition-colors">
                                        {{ tpl.templateName || 'æœªå‘½åæ¨¡æ¿' }}
                                    </div>
                                    <svg class="w-4 h-4 text-slate-400 group-hover:text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </div>
                                <div class="text-xs text-slate-500 dark:text-slate-400 mt-1 line-clamp-2">
                                    {{ tpl.note || 'ç„¡å‚™è¨»èªªæ˜' }}
                                </div>
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </transition>

    <!-- PRODUCT PICKER MODAL (Full screen on mobile) -->
    <transition name="modal">
        <div v-if="pickerState.isOpen" class="fixed inset-0 z-50 flex flex-col bg-slate-100 dark:bg-dark sm:bg-black/60 sm:backdrop-blur-sm sm:flex-row sm:items-center sm:justify-center p-0 sm:p-4">
            
            <!-- Modal Box -->
            <div class="bg-white dark:bg-surface w-full h-full sm:h-auto sm:max-h-[80vh] sm:max-w-lg sm:rounded-xl shadow-2xl flex flex-col relative transition-colors duration-300">
                
                <!-- Header / Search -->
                <div class="p-4 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-surface sticky top-0 z-10 sm:rounded-t-xl flex gap-3 items-center flex-nowrap">
                    <div class="relative flex-grow min-w-0">
                        <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        <input 
                            ref="pickerSearchInput"
                            v-model="pickerState.searchQuery" 
                            type="text" 
                            placeholder="æœå°‹å•†å“..." 
                            class="w-full pl-10 pr-4 py-3 bg-slate-100 dark:bg-slate-800 border-none rounded-lg text-slate-800 dark:text-white focus:ring-2 focus:ring-primary outline-none"
                        >
                    </div>
                    <!-- Close button as X icon -->
                    <button @click="closePicker" class="flex-shrink-0 w-10 h-10 flex items-center justify-center bg-slate-100 dark:bg-slate-700 rounded-full text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <!-- Product List -->
                <div class="flex-grow overflow-y-auto p-2 sm:p-4 custom-scrollbar">
                    
                    <!-- Exact Match / Custom Create Option -->
                    <div 
                        v-if="pickerState.searchQuery && !filteredProducts.some(p => p.name === pickerState.searchQuery)"
                        @click="selectCustomProduct(pickerState.searchQuery)"
                        class="p-4 mb-2 rounded-lg border-2 border-dashed border-primary/50 text-primary hover:bg-primary/5 cursor-pointer flex items-center gap-3 transition-colors"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        <div>
                            <div class="font-bold">ä½¿ç”¨ã€Œ{{ pickerState.searchQuery }}ã€</div>
                            <div class="text-xs opacity-70">ä½œç‚ºè‡ªå®šç¾©å•†å“åç¨±</div>
                        </div>
                    </div>

                    <!-- List Items -->
                    <div 
                        v-for="prod in filteredProducts" 
                        :key="prod.id"
                        @click="selectProduct(prod)"
                        class="p-4 mb-2 rounded-lg bg-slate-50 dark:bg-slate-700/30 hover:bg-primary/10 dark:hover:bg-primary/20 cursor-pointer border border-slate-100 dark:border-slate-700/50 flex items-center transition-colors active:scale-[0.98]"
                    >
                        <span class="font-bold text-slate-800 dark:text-slate-200 text-lg">{{ prod.name }}</span>
                    </div>

                    <!-- Empty State -->
                    <div v-if="filteredProducts.length === 0 && !pickerState.searchQuery" class="text-center py-10 text-slate-400 dark:text-slate-500">
                        <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                        <p>è«‹è¼¸å…¥é—œéµå­—æœå°‹å•†å“</p>
                    </div>
                </div>
            </div>
        </div>
    </transition>

    <!-- Copy Day Modal -->
    <transition name="modal">
        <div v-if="copyModal.isOpen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div @click="closeCopyModal" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
            <div class="bg-white dark:bg-surface rounded-xl border border-slate-200 dark:border-slate-600 shadow-2xl max-w-md w-full relative z-10 p-6 transition-colors duration-300">
                <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4">è¤‡è£½ã€Œ{{ currentDay }}ã€çš„è¡Œç¨‹åˆ°...</h3>
                
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <label 
                        v-for="day in weekDays.filter(d => d !== currentDay)" 
                        :key="day" 
                        class="flex items-center gap-3 p-3 rounded-lg border cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors"
                        :class="[
                            copyModal.selectedDays.includes(day) 
                                ? 'bg-primary/10 border-primary' 
                                : 'border-slate-200 dark:border-slate-700'
                        ]"
                    >
                        <input type="checkbox" :value="day" v-model="copyModal.selectedDays" class="w-4 h-4 rounded border-slate-300 dark:border-slate-500 text-primary focus:ring-primary bg-white dark:bg-dark">
                        <span class="text-slate-700 dark:text-slate-200">{{ day }}</span>
                    </label>
                </div>

                <div class="flex justify-end gap-3">
                    <button @click="closeCopyModal" class="px-4 py-2 rounded-lg text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-white">å–æ¶ˆ</button>
                    <button @click="submitCopy" class="px-6 py-2 rounded-lg bg-primary text-white hover:bg-violet-600 font-medium">ç¢ºèªè¤‡è£½</button>
                </div>
            </div>
        </div>
    </transition>

    <!-- Alert Modal -->
    <transition name="modal">
        <div v-if="modalState.isOpen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div @click="closeModal(false)" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
            <div class="bg-white dark:bg-surface rounded-xl border border-slate-200 dark:border-slate-600 shadow-2xl max-w-sm w-full relative z-10 p-6 transition-colors duration-300">
                <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-2">{{ modalState.type === 'alert' ? 'ğŸ”” æç¤º' : 'âš ï¸ ç¢ºèª' }}</h3>
                <p class="text-slate-600 dark:text-slate-300 mb-6">{{ modalState.message }}</p>
                <div class="flex justify-end gap-3">
                    <button v-if="modalState.type === 'confirm'" @click="closeModal(false)" class="px-4 py-2 rounded-lg text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-white">å–æ¶ˆ</button>
                    <button @click="closeModal(true)" class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-violet-600">ç¢ºå®š</button>
                </div>
            </div>
        </div>
    </transition>

    <!-- LINE Warning Modal -->
    <transition name="modal">
        <div v-if="lineModal.isOpen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div @click="lineModal.isOpen = false" class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>
            <div class="bg-white dark:bg-surface rounded-xl border border-slate-200 dark:border-slate-600 shadow-2xl max-w-sm w-full relative z-10 p-6 text-center transition-colors duration-300">
                <div class="w-16 h-16 bg-green-100 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                </div>
                <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-2">è«‹ä½¿ç”¨ç³»çµ±ç€è¦½å™¨</h3>
                <p class="text-slate-600 dark:text-slate-300 mb-6 text-sm text-left leading-relaxed">
                    LINE å…§å»ºç€è¦½å™¨ä¸æ”¯æ´æª”æ¡ˆä¸‹è¼‰åŠŸèƒ½ã€‚<br>
                    è«‹é»æ“Šå³ä¸Šè§’çš„é¸å–® <span class="inline-block bg-slate-200 dark:bg-slate-700 px-1 rounded">â‹®</span> æˆ– <span class="inline-block bg-slate-200 dark:bg-slate-700 px-1 rounded">â†—</span><br>
                    ä¸¦é¸æ“‡ <span class="font-bold text-primary">ã€Œä½¿ç”¨é è¨­ç€è¦½å™¨é–‹å•Ÿã€</span>ã€‚
                </p>
                <button @click="lineModal.isOpen = false" class="w-full px-4 py-2 rounded-lg bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-white font-medium">æˆ‘çŸ¥é“äº†</button>
            </div>
        </div>
    </transition>

</div>

<!-- Template for Time Block Section Component -->
<template id="time-block-section-template">
    <div class="bg-white dark:bg-surface rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm overflow-hidden transition-all hover:border-primary/50 dark:hover:border-slate-600">
        <div class="bg-slate-50 dark:bg-slate-700/30 px-6 py-3 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center gap-4">
            
            <!-- Time Input & Label -->
            <div class="flex items-center gap-2 flex-grow min-w-0">
                <input 
                    type="time" 
                    v-model="block.time" 
                    class="bg-transparent text-xl font-bold text-slate-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary rounded px-1 cursor-pointer flex-shrink-0 dark:[&::-webkit-calendar-picker-indicator]:invert"
                >
                <!-- Added Label Input -->
                <input 
                    type="text" 
                    v-model="block.label" 
                    placeholder="å‚™è¨»..." 
                    class="bg-transparent text-sm text-slate-600 dark:text-slate-300 focus:outline-none border-b border-transparent focus:border-primary hover:border-slate-300 dark:hover:border-slate-600 transition-colors flex-1 min-w-0"
                >
            </div>

            <div class="flex items-center gap-4 flex-shrink-0">
                <button 
                    type="button"
                    @click="$emit('delete-block')" 
                    class="text-slate-400 dark:text-slate-500 hover:text-red-500 dark:hover:text-red-400 transition-colors p-1.5 hover:bg-red-50 dark:hover:bg-red-500/10 rounded-lg" 
                    title="åˆªé™¤æ­¤æ™‚æ®µ"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
            </div>
        </div>

        <div class="p-4 bg-white dark:bg-surface">
            <div class="space-y-3">
                <div v-for="(item, idx) in block.items" :key="idx" class="grid grid-cols-12 gap-3 items-center bg-slate-50 dark:bg-dark/50 p-3 rounded-lg border border-slate-200 dark:border-slate-700/50 hover:border-slate-300 dark:hover:border-slate-600 transition-colors">
                    
                    <!-- Product Selection (Trigger Picker) -->
                    <div class="col-span-7 sm:col-span-8 relative group cursor-pointer" @click="$emit('open-picker', item)">
                        <label class="text-[10px] text-slate-500 dark:text-slate-500 uppercase font-bold mb-0.5 block">é¸æ“‡å•†å“</label>
                        <div class="relative">
                            <input 
                                type="text"
                                readonly
                                :value="item.productId ? getProductName(item.productId) : (item.unknownName || '')"
                                :placeholder="item.unknownName ? 'æœªçŸ¥: ' + item.unknownName : 'é»æ“Šé¸æ“‡å•†å“...'"
                                :class="[
                                    'w-full bg-white dark:bg-slate-800 text-sm border rounded-md px-2 py-1.5 focus:ring-1 outline-none transition-colors cursor-pointer',
                                    !item.productId && item.unknownName 
                                        ? 'border-red-500 text-red-500 dark:text-red-400 placeholder-red-400 focus:border-red-500 focus:ring-red-500' 
                                        : 'border-slate-300 dark:border-slate-600 text-slate-800 dark:text-white focus:border-primary focus:ring-primary'
                                ]"
                            >
                            <!-- Chevron Icon to indicate dropdown behavior -->
                            <div class="absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none">
                                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </div>
                    </div>

                    <!-- Quantity Input -->
                    <div class="col-span-4 sm:col-span-3">
                        <label class="text-[10px] text-slate-500 dark:text-slate-500 uppercase font-bold mb-0.5 block">æ•¸é‡</label>
                        <div class="flex items-center">
                            <input 
                                v-model.number="item.quantity" 
                                type="number" 
                                min="0" 
                                step="0.5"
                                class="w-full bg-white dark:bg-slate-800 text-sm border border-slate-300 dark:border-slate-600 rounded-md px-2 py-1.5 text-slate-800 dark:text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none text-center"
                            >
                            <span class="text-xs text-slate-500 dark:text-slate-500 ml-1 whitespace-nowrap">{{ getProductUnit(item.productId) }}</span>
                        </div>
                    </div>

                    <!-- Delete Item -->
                    <div class="col-span-1 text-center flex items-center justify-center">
                        <button type="button" @click.stop="$emit('remove-item', idx)" class="text-slate-400 hover:text-red-500 dark:text-slate-600 dark:hover:text-red-400 mt-4 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                </div>
                
                <button type="button" @click="$emit('add-item')" class="w-full py-2 border border-dashed border-slate-300 dark:border-slate-600 rounded-lg text-slate-500 dark:text-slate-500 hover:text-primary dark:hover:text-primary hover:border-primary dark:hover:border-primary hover:bg-primary/5 transition-all text-sm font-medium flex justify-center items-center gap-2 group">
                    <svg class="w-4 h-4 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    æ–°å¢é£Ÿæ
                </button>
            </div>
        </div>
    </div>
</template>

<script type="module">
    import { createApp, ref, reactive, computed, onMounted, watch, nextTick } from 'vue';
    import { initializeApp } from 'firebase/app';
    import { getFirestore, collection, onSnapshot, addDoc, getDoc, doc, serverTimestamp, query, where, getDocs } from 'firebase/firestore';

    // ==========================================
    // CONFIGURATION
    // ==========================================
    const firebaseConfig = {
        apiKey: "AIzaSyDYIbCdV49gV05_PDEHfBGpg8REOoZchgc",
        authDomain: "cost-calculator-74860.firebaseapp.com",
        projectId: "cost-calculator-74860",
        storageBucket: "cost-calculator-74860.firebasestorage.app",
        messagingSenderId: "1079472315078",
        appId: "1:1079472315078:web:e230b337dc3ec648bc15c7"
    };

    let db = null;
    if (firebaseConfig.apiKey) {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
    }

    // ==========================================
    // COMPONENT: Time Block
    // ==========================================
    const TimeBlockSection = {
        template: '#time-block-section-template',
        props: ['block', 'products'],
        emits: ['add-item', 'remove-item', 'delete-block', 'open-picker'],
        setup(props) {
            const getProduct = (id) => props.products.find(p => p.id === id);
            const getProductName = (id) => { const p = getProduct(id); return p ? p.name : ''; };
            const getProductUnit = (id) => { const p = getProduct(id); return p ? p.unit : '-'; };

            return { getProductName, getProductUnit };
        }
    };

    // ==========================================
    // MAIN APP
    // ==========================================
    const app = createApp({
        components: { 'time-block-section': TimeBlockSection },
        setup() {
            const products = ref([]);
            const weekDays = ['é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­', 'é€±æ—¥'];
            const currentDay = ref('é€±ä¸€');
            const isDark = ref(localStorage.getItem('theme') !== 'light');
            const fileInput = ref(null);
            const summaryNote = ref('');

            // --- THEME LOGIC ---
            const toggleTheme = () => {
                isDark.value = !isDark.value;
                if(isDark.value) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            };

            // --- DATA STRUCTURE: WEEKLY PLAN ---
            const weeklyPlan = ref({
                'é€±ä¸€': [], 'é€±äºŒ': [], 'é€±ä¸‰': [], 'é€±å››': [], 'é€±äº”': [], 'é€±å…­': [], 'é€±æ—¥': []
            });

            // Load from LocalStorage
            const loadPlan = () => {
                const savedPlan = JSON.parse(localStorage.getItem('weekly_meal_plan'));
                if(savedPlan) {
                    weeklyPlan.value = { ...weeklyPlan.value, ...savedPlan };
                }
                const savedNote = localStorage.getItem('summary_note');
                if (savedNote) {
                    summaryNote.value = savedNote;
                }
            };
            loadPlan();

            watch(weeklyPlan, (newVal) => {
                localStorage.setItem('weekly_meal_plan', JSON.stringify(newVal));
            }, { deep: true });
            
            watch(summaryNote, (newVal) => {
                localStorage.setItem('summary_note', newVal);
            });

            // --- BROWSER DETECTION (LINE) ---
            const lineModal = reactive({ isOpen: false });
            const isLineBrowser = () => {
                return /Line/i.test(navigator.userAgent);
            };

            // --- IMPORT / EXPORT LOGIC (FILE) ---
            const exportData = () => {
                if (isLineBrowser()) {
                    lineModal.isOpen = true;
                    return;
                }
                const exportObj = {
                    plan: weeklyPlan.value,
                    note: summaryNote.value
                };
                const dataStr = JSON.stringify(exportObj, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `weekly-plan-backup-${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            const triggerImport = () => {
                fileInput.value.click();
            };

            const handleImportFile = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        // Backwards compatibility check
                        if (json.plan) {
                             weeklyPlan.value = json.plan;
                             summaryNote.value = json.note || '';
                             await showAlert('åŒ¯å…¥æˆåŠŸï¼æ‚¨çš„è¡Œç¨‹èˆ‡å‚™è¨»å·²æ›´æ–°ã€‚');
                        } else if (typeof json === 'object' && ('é€±ä¸€' in json || 'Monday' in json)) {
                             weeklyPlan.value = json;
                             await showAlert('åŒ¯å…¥æˆåŠŸï¼æ‚¨çš„è¡Œç¨‹å·²æ›´æ–° (èˆŠæ ¼å¼)ã€‚');
                        } else {
                             await showAlert('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºã€‚');
                        }
                    } catch (error) {
                        console.error(error);
                        await showAlert('åŒ¯å…¥å¤±æ•—ï¼šç„¡æ³•è®€å–æª”æ¡ˆã€‚');
                    }
                    event.target.value = '';
                };
                reader.readAsText(file);
            };

            // --- CLOUD SYNC LOGIC (FIRESTORE) ---
            const cloudModal = reactive({
                isOpen: false,
                mode: 'save', // 'save', 'load', or 'templates'
                loading: false,
                savedId: '',
                inputId: ''
            });
            const templates = ref([]);

            const openCloudModal = () => {
                cloudModal.isOpen = true;
                cloudModal.savedId = '';
                cloudModal.inputId = '';
                cloudModal.loading = false;
                cloudModal.mode = 'save';
                templates.value = []; // Reset templates
            };
            
            const closeCloudModal = () => {
                cloudModal.isOpen = false;
            };

            const saveToCloud = async () => {
                if (!db) {
                    await showAlert('ç„¡æ³•é€£æ¥è‡³è³‡æ–™åº«');
                    return;
                }
                cloudModal.loading = true;
                try {
                    // Save to 'plans' collection with new structure fields initialized as default
                    const docRef = await addDoc(collection(db, "plans"), {
                        data: weeklyPlan.value,
                        note: summaryNote.value,
                        createdAt: serverTimestamp(),
                        version: 2,
                        isTemplate: false,
                        templateName: ''
                    });
                    cloudModal.savedId = docRef.id;
                } catch (e) {
                    console.error(e);
                    await showAlert('ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
                } finally {
                    cloudModal.loading = false;
                }
            };

            const loadFromCloud = async () => {
                if (!db) {
                    await showAlert('ç„¡æ³•é€£æ¥è‡³è³‡æ–™åº«');
                    return;
                }
                if (!cloudModal.inputId.trim()) return;

                cloudModal.loading = true;
                try {
                    const docRef = doc(db, "plans", cloudModal.inputId.trim());
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const cloudData = docSnap.data();
                        applyPlanData(cloudData);
                    } else {
                        await showAlert('æ‰¾ä¸åˆ°æ­¤ä»£ç¢¼çš„è³‡æ–™ï¼Œè«‹ç¢ºèªè¼¸å…¥æ˜¯å¦æ­£ç¢º');
                    }
                } catch (e) {
                    console.error(e);
                    await showAlert('ä¸‹è¼‰å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                } finally {
                    cloudModal.loading = false;
                }
            };

            // Fetch official templates
            const fetchTemplates = async () => {
                if (!db) {
                    await showAlert('ç„¡æ³•é€£æ¥è‡³è³‡æ–™åº«');
                    return;
                }
                cloudModal.loading = true;
                try {
                    const q = query(collection(db, "plans"), where("isTemplate", "==", true));
                    const querySnapshot = await getDocs(q);
                    templates.value = querySnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                } catch (e) {
                    console.error(e);
                    await showAlert('ç„¡æ³•è®€å–æ¨¡æ¿åˆ—è¡¨');
                } finally {
                    cloudModal.loading = false;
                }
            };

            // Select and apply a template
            const selectTemplate = async (template) => {
                const confirmed = await showConfirm(`ç¢ºå®šè¦å¥—ç”¨æ¨¡æ¿ã€Œ${template.templateName || 'æœªå‘½å'}ã€å—ï¼Ÿ\né€™å°‡æœƒè¦†è“‹æ‚¨ç›®å‰æ‰€æœ‰çš„è¡Œç¨‹å®‰æ’ã€‚`);
                if (confirmed) {
                    applyPlanData(template);
                }
            };

            // Helper to apply plan data (used by Load and Template)
            const applyPlanData = async (cloudData) => {
                // Support legacy cloud data without 'data' field nesting
                const planData = cloudData.data || cloudData; 
                
                // Check if it looks like a plan structure
                if (planData['é€±ä¸€'] || planData['Monday']) {
                    weeklyPlan.value = planData;
                    summaryNote.value = cloudData.note || '';
                    closeCloudModal();
                    await showAlert('è¡Œç¨‹å·²æ›´æ–°ï¼');
                } else {
                    await showAlert('è³‡æ–™æ ¼å¼éŒ¯èª¤');
                }
            };

            const clearAllData = async () => {
                const confirmed = await showConfirm('âš ï¸ è­¦å‘Šï¼šç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å¤©æ•¸çš„è¡Œç¨‹å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚');
                if (confirmed) {
                    weeklyPlan.value = {
                        'é€±ä¸€': [], 'é€±äºŒ': [], 'é€±ä¸‰': [], 'é€±å››': [], 'é€±äº”': [], 'é€±å…­': [], 'é€±æ—¥': []
                    };
                    summaryNote.value = '';
                    localStorage.removeItem('weekly_meal_plan');
                    localStorage.removeItem('summary_note');
                }
            };

            // Computed: Current Day's Blocks Sorted by Time
            const sortedCurrentDayLog = computed(() => {
                return [...weeklyPlan.value[currentDay.value]].sort((a, b) => a.time.localeCompare(b.time));
            });

            // Helper for report: Get sorted blocks for ANY day
            const getSortedBlocks = (day) => {
                if(!weeklyPlan.value[day]) return [];
                return [...weeklyPlan.value[day]].sort((a, b) => a.time.localeCompare(b.time));
            };

            // Helper for report: Product Info
            const getProduct = (id) => products.value.find(p => p.id === id);
            const getProductName = (id) => { const p = getProduct(id); return p ? p.name : ''; };
            const getProductUnit = (id) => { const p = getProduct(id); return p ? p.unit : '-'; };

            // Computed: Check if there is ANY data in the whole week
            const hasAnyData = computed(() => {
                return Object.values(weeklyPlan.value).some(dayArr => dayArr.length > 0);
            });

            // --- SUMMARY LOGIC ---
            const weeklySummary = computed(() => {
                const summary = {};
                
                Object.values(weeklyPlan.value).forEach(dayBlocks => {
                    dayBlocks.forEach(block => {
                        block.items.forEach(item => {
                            if (!item.quantity) return;
                            
                            // Key by Product ID or Name (for unknown items)
                            const key = item.productId || item.unknownName;
                            if (!key) return;

                            if (!summary[key]) {
                                let name = item.unknownName;
                                let unit = '-';
                                let packSize = null;
                                let packageUnit = null;
                                
                                const p = products.value.find(p => p.id === item.productId);
                                if (p) {
                                    name = p.name;
                                    unit = p.unit;
                                    packSize = p.packSize;
                                    packageUnit = p.packageUnit;
                                }

                                summary[key] = {
                                    name: name || 'æœªçŸ¥å•†å“',
                                    unit: unit,
                                    totalQuantity: 0,
                                    packSize,
                                    packageUnit
                                };
                            }
                            summary[key].totalQuantity += item.quantity;
                        });
                    });
                });
                return summary;
            });

            // --- MODAL LOGIC ---
            const modalState = reactive({ isOpen: false, type: 'alert', message: '', resolve: null });
            const showConfirm = (message) => new Promise(r => { modalState.type='confirm'; modalState.message=message; modalState.isOpen=true; modalState.resolve=r; });
            const showAlert = (message) => new Promise(r => { modalState.type='alert'; modalState.message=message; modalState.isOpen=true; modalState.resolve=r; });
            const closeModal = (result) => { modalState.isOpen=false; if(modalState.resolve) { modalState.resolve(result); modalState.resolve=null; }};

            // --- PRODUCT PICKER LOGIC ---
            const pickerState = reactive({
                isOpen: false,
                searchQuery: '',
                targetItem: null // Reference to the item object being edited
            });
            const pickerSearchInput = ref(null);

            const openPicker = (item) => {
                pickerState.targetItem = item;
                // If item already has a name, pre-fill search (optional, or keep empty to search new)
                pickerState.searchQuery = ''; 
                pickerState.isOpen = true;
                nextTick(() => {
                    if(pickerSearchInput.value) pickerSearchInput.value.focus();
                });
            };

            const closePicker = () => {
                pickerState.isOpen = false;
                pickerState.targetItem = null;
                pickerState.searchQuery = '';
            };

            const selectProduct = (product) => {
                if (pickerState.targetItem) {
                    pickerState.targetItem.productId = product.id;
                    pickerState.targetItem.unknownName = null;
                }
                closePicker();
            };

            const selectCustomProduct = (name) => {
                if (pickerState.targetItem) {
                    pickerState.targetItem.productId = '';
                    pickerState.targetItem.unknownName = name;
                }
                closePicker();
            };

            const filteredProducts = computed(() => {
                const q = pickerState.searchQuery.toLowerCase().trim();
                if(!q) return products.value;
                return products.value.filter(p => p.name.toLowerCase().includes(q));
            });


            // --- COPY SCHEDULE LOGIC ---
            const copyModal = reactive({ isOpen: false, selectedDays: [] });
            const openCopyModal = () => { copyModal.selectedDays = []; copyModal.isOpen = true; };
            const closeCopyModal = () => { copyModal.isOpen = false; };
            const submitCopy = async () => {
                if (copyModal.selectedDays.length === 0) return closeCopyModal();
                
                const confirmed = await showConfirm(`ç¢ºå®šè¦å°‡ ${currentDay.value} çš„è¡Œç¨‹è¦†è“‹åˆ° [${copyModal.selectedDays.join(', ')}] å—ï¼ŸåŸæœ¬çš„è³‡æ–™å°‡æœƒæ¶ˆå¤±ã€‚`);
                if (!confirmed) return;

                const sourceBlocks = JSON.parse(JSON.stringify(weeklyPlan.value[currentDay.value]));
                
                // Regenerate IDs to avoid key conflicts
                copyModal.selectedDays.forEach(day => {
                    weeklyPlan.value[day] = sourceBlocks.map(b => ({
                        ...b,
                        id: Date.now() + Math.random(),
                        items: b.items.map(i => ({...i}))
                    }));
                });
                
                closeCopyModal();
                showAlert("è¡Œç¨‹è¤‡è£½æˆåŠŸï¼");
            };

            // --- OPERATIONS ---
            const addTimeBlock = () => {
                const now = new Date();
                const timeStr = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                weeklyPlan.value[currentDay.value].push({
                    id: Date.now() + Math.random(),
                    time: timeStr,
                    label: '',
                    items: []
                });
            };

            const removeTimeBlock = async (blockId) => {
                const confirmed = await showConfirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ™‚æ®µå—ï¼Ÿ');
                if(!confirmed) return;
                const arr = weeklyPlan.value[currentDay.value];
                const idx = arr.findIndex(b => b.id === blockId);
                if(idx !== -1) arr.splice(idx, 1);
            };

            const addItemToBlock = (block) => block.items.push({ productId: '', quantity: 1 });
            const removeItemFromBlock = (block, idx) => block.items.splice(idx, 1);

            // --- FIRESTORE ---
            onMounted(() => {
                if (!db) return;
                onSnapshot(collection(db, "products"), (snapshot) => {
                    products.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.name.localeCompare(b.name));
                });
                
                // Check if user is still in LINE browser (redirect failed)
                if (isLineBrowser()) {
                    lineModal.isOpen = true;
                }
            });

            // --- EXPORT ---
            const downloadImage = () => {
                if (isLineBrowser()) {
                    lineModal.isOpen = true;
                    return;
                }
                
                // 1. Clone the capture area
                const originalElement = document.getElementById('capture-area');
                const clone = originalElement.cloneNode(true);
                
                // 2. Prepare a container for the clone (off-screen, fixed width for consistency)
                const container = document.createElement('div');
                container.style.position = 'fixed';
                container.style.top = '-10000px';
                container.style.left = '-10000px';
                container.style.width = '800px'; // Fixed A4-like width
                container.style.zIndex = '-1000';
                
                // 3. Force "Light Mode" and Clean Styles on the Clone
                // We recursively remove dark mode classes to ensure white background
                const removeDarkClasses = (el) => {
                    if (el.classList) {
                        el.classList.remove('dark');
                        // Replace bg-surface or dark bg colors with white/slate-50
                        if (el.classList.contains('dark:bg-surface')) el.classList.remove('dark:bg-surface');
                        if (el.classList.contains('bg-surface')) {
                             el.classList.remove('bg-surface');
                             el.classList.add('bg-white');
                        }
                        // Ensure text is black/slate-800
                        if (el.classList.contains('dark:text-white')) el.classList.remove('dark:text-white');
                        if (el.classList.contains('text-white') && !el.parentElement.classList.contains('bg-primary')) {
                             // Keep text-white only on primary headers
                             el.classList.remove('text-white');
                             el.classList.add('text-slate-900');
                        }
                    }
                    Array.from(el.children).forEach(removeDarkClasses);
                };
                removeDarkClasses(clone);

                // è¡Œç¨‹å¡ç‰‡ (ç‰¹å¾µæ˜¯ bg-slate-50)ï¼Œå¼·åˆ¶èƒŒæ™¯è®Šæ›´æ·ºï¼Œæ–‡å­—è®Šå…¨é»‘
                const cards = clone.querySelectorAll('.bg-slate-50');
                cards.forEach(card => {
                    // èƒŒæ™¯è¨­å®šï¼šæ”¹ç‚ºå¹¾ä¹ç´”ç™½ï¼Œä¸¦åŠ ä¸Šç¨å¾®æ·±ä¸€é»çš„é‚Šæ¡†è®“å®ƒæ¸…æ¥š
                    card.style.backgroundColor = '#ffffff'; 
                    card.style.border = '1px solid #d1d5db'; // ç°è‰²é‚Šæ¡†
                    
                    // æ–‡å­—è¨­å®šï¼šå¼·åˆ¶å¡ç‰‡å…§æ‰€æœ‰æ–‡å­—è®Šæˆç´”é»‘è‰²
                    card.style.color = '#000000';
                    card.querySelectorAll('*').forEach(child => {
                        // è¦†è“‹åŸæœ¬ slate-600 / slate-500 çš„ç°è‰²æ–‡å­—
                        child.style.color = '#000000';
                    });
                });

                // ç¸½æ¸…å–®çš„å•†å“åç¨± (ç‰¹å¾µæ˜¯ text-slate-800)ï¼Œå¼·åˆ¶æ”¹ç‚ºç´”é»‘
                // é€™è£¡æˆ‘å€‘é‡å° #capture-area è£¡é¢çš„ç‰¹å®šæ–‡å­— class é€²è¡ŒåŠ å¼·
                const summaryTexts = clone.querySelectorAll('#capture-area .text-slate-800');
                summaryTexts.forEach(text => {
                    text.style.color = '#000000'; // ç´”é»‘
                    text.style.fontWeight = '800'; // åŠ ç²—ï¼Œè®“åˆ—å°æ™‚æ›´æ¸…æ¥š
                });

                // æ‰¾å‡ºé‚£å€‹æ·ºç´«è‰²çš„æ•¸å­—å¤–æ¡† (ç‰¹å¾µæ˜¯ bg-purple-50 ä¸” text-primary)
                const numberBadges = clone.querySelectorAll('.bg-purple-50.text-primary');
                numberBadges.forEach(badge => {
                    // A. å°‡æ•¸å­—æœ¬èº«æ”¹æˆæ·±ç´«è‰² (ä½¿ç”¨ Tailwind çš„ Purple-900 è‰²ç¢¼)
                    badge.style.color = '#581c87'; 
                    
                    // B. å°‡è£¡é¢çš„ã€Œå–®ä½ã€å°å­—æ”¹æˆç´”é»‘è‰² (Including new info text inside badge)
                    badge.querySelectorAll('span').forEach(span => {
                         span.style.color = '#000000';
                    });
                });
                
                // Force new purchase calculation line to be black
                const purchaseLines = clone.querySelectorAll('.text-sm.font-bold.text-slate-600');
                purchaseLines.forEach(el => el.style.color = '#000000');
                
                // Specific Overrides for the Clone
                clone.style.backgroundColor = '#ffffff';
                clone.style.color = '#000000';
                clone.style.borderRadius = '0';
                clone.style.boxShadow = 'none';
                clone.style.padding = '20px';
                
                // FIX: Manual Textarea Handling for Note (Value not cloned) & Styling
                const originalTextarea = originalElement.querySelector('textarea');
                const clonedTextarea = clone.querySelector('textarea');
                
                if (originalTextarea && clonedTextarea) {
                    const textDiv = document.createElement('div');
                    textDiv.innerText = originalTextarea.value;
                    // Dark background for note, white text
                    textDiv.style.cssText = "width: 100%; min-height: 80px; padding: 12px; border: 1px solid #475569; border-radius: 8px; background-color: #1e293b; color: white; white-space: pre-wrap; font-size: 14px;";
                    clonedTextarea.parentNode.replaceChild(textDiv, clonedTextarea);
                }
                
                container.appendChild(clone);
                document.body.appendChild(container);

                // 4. Capture using html2canvas on the clean clone
                html2canvas(clone, { 
                    scale: 2, // High resolution
                    backgroundColor: '#ffffff',
                    useCORS: true,
                    windowWidth: 800
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `æœ¬é€±é£²é£Ÿè¨ˆç•«è¡¨-${new Date().toISOString().slice(0,10)}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                    
                    // Cleanup
                    document.body.removeChild(container);
                }).catch(err => {
                    console.error("Capture failed", err);
                    document.body.removeChild(container);
                });
            };

            return {
                currentDay, weekDays, weeklyPlan, sortedCurrentDayLog, products,
                modalState, copyModal, weeklySummary, isDark, toggleTheme, summaryNote,
                addTimeBlock, removeTimeBlock, addItemToBlock, removeItemFromBlock,
                openCopyModal, closeCopyModal, submitCopy,
                closeModal, downloadImage,
                // New exports for the summary view
                getSortedBlocks, getProductName, getProductUnit, hasAnyData,
                // Picker exports
                pickerState, openPicker, closePicker, selectProduct, selectCustomProduct, filteredProducts, pickerSearchInput,
                // Import/Export exports
                exportData, triggerImport, handleImportFile, clearAllData, fileInput,
                // Cloud Sync
                cloudModal, openCloudModal, closeCloudModal, saveToCloud, loadFromCloud, fetchTemplates, templates, selectTemplate,
                // LINE fix
                lineModal
            };
        }
    });

    app.mount('#app');
</script>

</body>
</html>