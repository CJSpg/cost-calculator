<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯é€±é£²é£Ÿè¦åŠƒè¡¨</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#8B5CF6', // Violet 500
                        secondary: '#EC4899', // Pink 500
                        dark: '#0F172A', // Slate 900
                        surface: '#1E293B', // Slate 800
                    }
                }
            }
        }
    </script>

    <!-- html2canvas for Image Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Vue.js 3 -->
    <script type="importmap">
        {
          "imports": {
            "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js",
            "firebase/app": "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"
          }
        }
    </script>
    
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        .list-move, .list-enter-active, .list-leave-active { transition: all 0.5s ease; }
        .list-enter-from, .list-leave-to { opacity: 0; transform: translateX(30px); }
        .list-leave-active { position: absolute; width: 100%; }
        
        .modal-enter-active, .modal-leave-active { transition: opacity 0.2s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }

        @media print {
            body { background: white; color: black; }
            .no-print, header, .edit-controls { display: none !important; }
            .print-only { display: block !important; }
            #capture-area { padding: 0; background: white; }
            .text-white { color: black !important; }
            .text-slate-300, .text-slate-400, .text-slate-500 { color: #555 !important; }
        }
    </style>
</head>
<body class="bg-dark text-slate-200 min-h-screen font-sans">

<div id="app" class="flex flex-col min-h-screen">
    
    <!-- Header -->
    <header class="bg-surface border-b border-slate-700 shadow-lg sticky top-0 z-40 no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <svg class="w-8 h-8 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                <h1 class="text-xl font-bold tracking-wide text-white">Weekly<span class="text-primary">Plan</span></h1>
            </div>
            
            <a href="admin.html" class="text-xs text-slate-500 hover:text-primary transition-colors flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                å¾Œå°
            </a>
        </div>
    </header>

    <!-- Content -->
    <main class="flex-grow p-4 sm:p-6 max-w-7xl mx-auto w-full relative z-0">

        <!-- Day Navigation -->
        <div class="flex overflow-x-auto pb-2 gap-2 no-print custom-scrollbar">
            <button 
                v-for="day in weekDays" 
                :key="day"
                @click="currentDay = day"
                type="button"
                :class="[
                    'flex-shrink-0 px-6 py-3 rounded-xl font-bold text-sm transition-all duration-200 border border-transparent',
                    currentDay === day 
                        ? 'bg-primary text-white shadow-lg shadow-primary/25 scale-105' 
                        : 'bg-surface text-slate-400 hover:bg-slate-700 hover:border-slate-600'
                ]"
            >
                {{ day }}
            </button>
        </div>

        <!-- Controls & Current Day Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-surface p-4 rounded-xl border border-slate-700 mt-6">
            <div>
                <h2 class="text-2xl font-bold text-white">{{ currentDay }} <span class="text-slate-500 text-base font-normal">è¡Œç¨‹è¦åŠƒ</span></h2>
                <p class="text-xs text-slate-400 mt-1">å®‰æ’ä»Šæ—¥çš„é£²é£Ÿæ™‚æ®µèˆ‡æ•¸é‡</p>
            </div>
            <div class="flex gap-2">
                <button 
                    @click="openCopyModal"
                    type="button"
                    class="flex items-center gap-2 px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white transition-colors text-sm font-medium"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"></path></svg>
                    è¤‡è£½è¡Œç¨‹åˆ°åˆ¥å¤©
                </button>
            </div>
        </div>

        <!-- Timeline / Blocks for Current Day -->
        <div class="relative min-h-[300px] mt-6">
            <transition-group name="list" tag="div" class="space-y-6">
                <time-block-section 
                    v-for="block in sortedCurrentDayLog" 
                    :key="block.id"
                    :block="block"
                    :products="products"
                    @delete-block="removeTimeBlock(block.id)"
                    @add-item="addItemToBlock(block)"
                    @remove-item="(idx) => removeItemFromBlock(block, idx)"
                ></time-block-section>
            </transition-group>

            <!-- Add Time Block Button -->
            <button 
                @click="addTimeBlock"
                type="button"
                class="w-full mt-6 bg-dark border-2 border-dashed border-slate-600 hover:border-primary hover:text-primary text-slate-400 rounded-xl p-6 flex flex-col items-center justify-center gap-2 transition-all group"
            >
                <svg class="w-8 h-8 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                <span class="font-medium">æ–°å¢æ™‚æ®µ</span>
            </button>
        </div>

        <!-- Weekly Summary Section (Print Area) -->
        <div id="capture-area" class="mt-12 bg-white text-slate-900 rounded-xl overflow-hidden shadow-xl mb-12">
            <div class="bg-primary px-6 py-4 flex justify-between items-center">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                    æœ¬é€±æ¡è³¼ç¸½æ¸…å–®
                </h3>
                <div class="text-xs text-white/80 no-print">è‡ªå‹•çµ±è¨ˆæ‰€æœ‰å¤©æ•¸</div>
            </div>
            
            <div class="p-6">
                <div v-if="Object.keys(weeklySummary).length === 0" class="text-center text-slate-400 py-8">
                    å°šæœªå®‰æ’ä»»ä½•è¡Œç¨‹ï¼Œè«‹å…ˆè‡³ä¸Šæ–¹å¡«å¯«æ¯æ—¥è¦åŠƒã€‚
                </div>
                <div v-else class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div v-for="(item, key) in weeklySummary" :key="key" class="flex justify-between items-center border-b border-slate-200 pb-2">
                        <span class="font-bold text-lg text-slate-800">{{ item.name }}</span>
                        <span class="font-mono text-xl text-primary font-bold bg-purple-50 px-2 rounded">
                            {{ item.totalQuantity }} <span class="text-xs text-slate-500 ml-1">{{ item.unit }}</span>
                        </span>
                    </div>
                </div>
            </div>

            <div class="bg-slate-100 px-6 py-4 border-t border-slate-200 flex justify-end gap-3 no-print">
                <button @click="downloadImage" type="button" class="px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 transition-colors flex items-center gap-2 text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    ä¸‹è¼‰åœ–ç‰‡
                </button>
            </div>
        </div>

    </main>

    <!-- Copy Day Modal -->
    <transition name="modal">
        <div v-if="copyModal.isOpen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div @click="closeCopyModal" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
            <div class="bg-surface rounded-xl border border-slate-600 shadow-2xl max-w-md w-full relative z-10 p-6">
                <h3 class="text-lg font-bold text-white mb-4">è¤‡è£½ã€Œ{{ currentDay }}ã€çš„è¡Œç¨‹åˆ°...</h3>
                
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <label 
                        v-for="day in weekDays.filter(d => d !== currentDay)" 
                        :key="day" 
                        class="flex items-center gap-3 p-3 rounded-lg border border-slate-700 cursor-pointer hover:bg-slate-700/50 transition-colors"
                        :class="copyModal.selectedDays.includes(day) ? 'bg-primary/20 border-primary' : ''"
                    >
                        <input type="checkbox" :value="day" v-model="copyModal.selectedDays" class="w-4 h-4 rounded border-slate-500 text-primary focus:ring-primary bg-dark">
                        <span class="text-slate-200">{{ day }}</span>
                    </label>
                </div>

                <div class="flex justify-end gap-3">
                    <button @click="closeCopyModal" class="px-4 py-2 rounded-lg text-slate-400 hover:text-white">å–æ¶ˆ</button>
                    <button @click="submitCopy" class="px-6 py-2 rounded-lg bg-primary text-white hover:bg-violet-600 font-medium">ç¢ºèªè¤‡è£½</button>
                </div>
            </div>
        </div>
    </transition>

    <!-- Alert Modal -->
    <transition name="modal">
        <div v-if="modalState.isOpen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div @click="closeModal(false)" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
            <div class="bg-surface rounded-xl border border-slate-600 shadow-2xl max-w-sm w-full relative z-10 p-6">
                <h3 class="text-lg font-bold text-white mb-2">{{ modalState.type === 'alert' ? 'ğŸ”” æç¤º' : 'âš ï¸ ç¢ºèª' }}</h3>
                <p class="text-slate-300 mb-6">{{ modalState.message }}</p>
                <div class="flex justify-end gap-3">
                    <button v-if="modalState.type === 'confirm'" @click="closeModal(false)" class="px-4 py-2 rounded-lg text-slate-400 hover:text-white">å–æ¶ˆ</button>
                    <button @click="closeModal(true)" class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-violet-600">ç¢ºå®š</button>
                </div>
            </div>
        </div>
    </transition>

</div>

<!-- Template for Time Block Section Component -->
<template id="time-block-section-template">
    <div class="bg-surface rounded-xl border border-slate-700 shadow-sm overflow-hidden transition-all hover:border-slate-600">
        <div class="bg-slate-700/30 px-6 py-3 border-b border-slate-700 flex justify-between items-center gap-4">
            
            <!-- Time Input -->
            <div class="flex items-center gap-3">
                <div class="bg-slate-800 p-2 rounded-lg border border-slate-600">
                    <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <input 
                    type="time" 
                    v-model="block.time" 
                    class="bg-transparent text-xl font-bold text-white focus:outline-none focus:ring-2 focus:ring-primary/50 rounded px-1 cursor-pointer"
                >
            </div>

            <div class="flex items-center gap-4">
                <button 
                    type="button"
                    @click="$emit('delete-block')" 
                    class="text-slate-500 hover:text-red-400 transition-colors p-1.5 hover:bg-red-500/10 rounded-lg" 
                    title="åˆªé™¤æ­¤æ™‚æ®µ"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
            </div>
        </div>

        <div class="p-4">
            <div class="space-y-3">
                <div v-for="(item, idx) in block.items" :key="idx" class="grid grid-cols-12 gap-3 items-center bg-dark/50 p-3 rounded-lg border border-slate-700/50 hover:border-slate-600 transition-colors">
                    
                    <!-- Product Search/Select -->
                    <div class="col-span-7 sm:col-span-8 relative">
                        <label class="text-[10px] text-slate-500 uppercase font-bold mb-0.5 block">é¸æ“‡å•†å“</label>
                        <input 
                            list="product-options" 
                            :value="item.productId ? getProductName(item.productId) : (item.unknownName || '')"
                            @input="handleProductSelect($event, item)"
                            @change="handleProductSelect($event, item)"
                            :placeholder="item.unknownName ? 'æœªçŸ¥: ' + item.unknownName : 'æœå°‹å•†å“...'"
                            :class="[
                                'w-full bg-slate-800 text-sm border rounded-md px-2 py-1.5 focus:ring-1 outline-none transition-colors',
                                !item.productId && item.unknownName 
                                    ? 'border-red-500 text-red-400 placeholder-red-400 focus:border-red-500 focus:ring-red-500' 
                                    : 'border-slate-600 text-white focus:border-primary focus:ring-primary'
                            ]"
                        >
                    </div>

                    <!-- Quantity Input -->
                    <div class="col-span-4 sm:col-span-3">
                        <label class="text-[10px] text-slate-500 uppercase font-bold mb-0.5 block">æ•¸é‡</label>
                        <div class="flex items-center">
                            <input 
                                v-model.number="item.quantity" 
                                type="number" 
                                min="0" 
                                step="0.5"
                                class="w-full bg-slate-800 text-sm border border-slate-600 rounded-md px-2 py-1.5 text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none text-center"
                            >
                            <span class="text-xs text-slate-500 ml-1 whitespace-nowrap">{{ getProductUnit(item.productId) }}</span>
                        </div>
                    </div>

                    <!-- Delete Item -->
                    <div class="col-span-1 text-center flex items-center justify-center">
                        <button type="button" @click="$emit('remove-item', idx)" class="text-slate-600 hover:text-red-400 mt-4 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                </div>
                
                <button type="button" @click="$emit('add-item')" class="w-full py-2 border border-dashed border-slate-600 rounded-lg text-slate-500 hover:text-primary hover:border-primary hover:bg-primary/5 transition-all text-sm font-medium flex justify-center items-center gap-2 group">
                    <svg class="w-4 h-4 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    æ–°å¢é£Ÿæ
                </button>
            </div>
        </div>
    </div>
</template>

<datalist id="product-options"></datalist>

<script type="module">
    import { createApp, ref, reactive, computed, onMounted, watch } from 'vue';
    import { initializeApp } from 'firebase/app';
    import { getFirestore, collection, onSnapshot } from 'firebase/firestore';

    // ==========================================
    // CONFIGURATION
    // ==========================================
    const firebaseConfig = {
        apiKey: "AIzaSyDYIbCdV49gV05_PDEHfBGpg8REOoZchgc",
        authDomain: "cost-calculator-74860.firebaseapp.com",
        projectId: "cost-calculator-74860",
        storageBucket: "cost-calculator-74860.firebasestorage.app",
        messagingSenderId: "1079472315078",
        appId: "1:1079472315078:web:e230b337dc3ec648bc15c7"
    };

    let db = null;
    if (firebaseConfig.apiKey) {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
    }

    // ==========================================
    // COMPONENT: Time Block
    // ==========================================
    const TimeBlockSection = {
        template: '#time-block-section-template',
        props: ['block', 'products'],
        emits: ['add-item', 'remove-item', 'delete-block'],
        setup(props) {
            const getProduct = (id) => props.products.find(p => p.id === id);
            const getProductName = (id) => { const p = getProduct(id); return p ? p.name : ''; };
            const getProductUnit = (id) => { const p = getProduct(id); return p ? p.unit : '-'; };

            const handleProductSelect = (event, item) => {
                const val = event.target.value;
                const product = props.products.find(p => p.name === val);
                if (product) {
                    item.productId = product.id;
                    item.unknownName = null;
                } else {
                    item.productId = '';
                    item.unknownName = val; // Store custom name if needed
                }
            };

            return { getProductName, getProductUnit, handleProductSelect };
        }
    };

    // ==========================================
    // MAIN APP
    // ==========================================
    const app = createApp({
        components: { 'time-block-section': TimeBlockSection },
        setup() {
            const products = ref([]);
            const weekDays = ['é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­', 'é€±æ—¥'];
            const currentDay = ref('é€±ä¸€');

            // --- DATA STRUCTURE: WEEKLY PLAN ---
            const weeklyPlan = ref({
                'é€±ä¸€': [], 'é€±äºŒ': [], 'é€±ä¸‰': [], 'é€±å››': [], 'é€±äº”': [], 'é€±å…­': [], 'é€±æ—¥': []
            });

            // Load from LocalStorage
            const savedPlan = JSON.parse(localStorage.getItem('weekly_meal_plan'));
            if(savedPlan) {
                weeklyPlan.value = { ...weeklyPlan.value, ...savedPlan };
            }

            watch(weeklyPlan, (newVal) => {
                localStorage.setItem('weekly_meal_plan', JSON.stringify(newVal));
            }, { deep: true });

            // Computed: Current Day's Blocks Sorted by Time
            const sortedCurrentDayLog = computed(() => {
                return [...weeklyPlan.value[currentDay.value]].sort((a, b) => a.time.localeCompare(b.time));
            });

            // --- SUMMARY LOGIC ---
            const weeklySummary = computed(() => {
                const summary = {};
                
                Object.values(weeklyPlan.value).forEach(dayBlocks => {
                    dayBlocks.forEach(block => {
                        block.items.forEach(item => {
                            if (!item.quantity) return;
                            
                            // Key by Product ID or Name (for unknown items)
                            const key = item.productId || item.unknownName;
                            if (!key) return;

                            if (!summary[key]) {
                                let name = item.unknownName;
                                let unit = '-';
                                
                                const p = products.value.find(p => p.id === item.productId);
                                if (p) {
                                    name = p.name;
                                    unit = p.unit;
                                }

                                summary[key] = {
                                    name: name || 'æœªçŸ¥å•†å“',
                                    unit: unit,
                                    totalQuantity: 0
                                };
                            }
                            summary[key].totalQuantity += item.quantity;
                        });
                    });
                });
                return summary;
            });

            // --- MODAL LOGIC ---
            const modalState = reactive({ isOpen: false, type: 'alert', message: '', resolve: null });
            const showConfirm = (message) => new Promise(r => { modalState.type='confirm'; modalState.message=message; modalState.isOpen=true; modalState.resolve=r; });
            const showAlert = (message) => new Promise(r => { modalState.type='alert'; modalState.message=message; modalState.isOpen=true; modalState.resolve=r; });
            const closeModal = (result) => { modalState.isOpen=false; if(modalState.resolve) { modalState.resolve(result); modalState.resolve=null; }};

            // --- COPY SCHEDULE LOGIC ---
            const copyModal = reactive({ isOpen: false, selectedDays: [] });
            const openCopyModal = () => { copyModal.selectedDays = []; copyModal.isOpen = true; };
            const closeCopyModal = () => { copyModal.isOpen = false; };
            const submitCopy = async () => {
                if (copyModal.selectedDays.length === 0) return closeCopyModal();
                
                const confirmed = await showConfirm(`ç¢ºå®šè¦å°‡ ${currentDay.value} çš„è¡Œç¨‹è¦†è“‹åˆ° [${copyModal.selectedDays.join(', ')}] å—ï¼ŸåŸæœ¬çš„è³‡æ–™å°‡æœƒæ¶ˆå¤±ã€‚`);
                if (!confirmed) return;

                const sourceBlocks = JSON.parse(JSON.stringify(weeklyPlan.value[currentDay.value]));
                
                // Regenerate IDs to avoid key conflicts
                copyModal.selectedDays.forEach(day => {
                    weeklyPlan.value[day] = sourceBlocks.map(b => ({
                        ...b,
                        id: Date.now() + Math.random(),
                        items: b.items.map(i => ({...i}))
                    }));
                });
                
                closeCopyModal();
                showAlert("è¡Œç¨‹è¤‡è£½æˆåŠŸï¼");
            };

            // --- OPERATIONS ---
            const addTimeBlock = () => {
                const now = new Date();
                const timeStr = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                weeklyPlan.value[currentDay.value].push({
                    id: Date.now() + Math.random(),
                    time: timeStr,
                    items: []
                });
            };

            const removeTimeBlock = async (blockId) => {
                const confirmed = await showConfirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ™‚æ®µå—ï¼Ÿ');
                if(!confirmed) return;
                const arr = weeklyPlan.value[currentDay.value];
                const idx = arr.findIndex(b => b.id === blockId);
                if(idx !== -1) arr.splice(idx, 1);
            };

            const addItemToBlock = (block) => block.items.push({ productId: '', quantity: 1 });
            const removeItemFromBlock = (block, idx) => block.items.splice(idx, 1);

            // --- FIRESTORE ---
            onMounted(() => {
                if (!db) return;
                onSnapshot(collection(db, "products"), (snapshot) => {
                    products.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.name.localeCompare(b.name));
                    updateDatalistDOM();
                });
            });

            const updateDatalistDOM = () => {
                const el = document.getElementById('product-options');
                if(el) {
                    el.innerHTML = '';
                    products.value.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.name;
                        opt.textContent = `å–®ä½: ${p.unit}`;
                        el.appendChild(opt);
                    });
                }
            };
            watch(products, updateDatalistDOM, { flush: 'post' });

            // --- EXPORT ---
            const downloadImage = () => {
                const element = document.getElementById('capture-area');
                html2canvas(element, { scale: 2 }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'weekly-shopping-list.png';
                    link.href = canvas.toDataURL();
                    link.click();
                });
            };

            return {
                currentDay, weekDays, weeklyPlan, sortedCurrentDayLog, products,
                modalState, copyModal, weeklySummary,
                addTimeBlock, removeTimeBlock, addItemToBlock, removeItemFromBlock,
                openCopyModal, closeCopyModal, submitCopy,
                closeModal, downloadImage
            };
        }
    });

    app.mount('#app');
</script>

</body>
</html>