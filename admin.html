<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“ç®¡ç†å¾Œå° - WeeklyPlan</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Init theme immediately to prevent flash
        if (localStorage.getItem('theme') === 'light') {
            document.documentElement.classList.remove('dark');
        } else {
            document.documentElement.classList.add('dark');
        }

        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#8B5CF6', // Violet 500
                        secondary: '#EC4899', // Pink 500
                        dark: '#0F172A', // Slate 900
                        surface: '#1E293B', // Slate 800
                        light: '#F8FAFC', // Slate 50
                        'surface-light': '#FFFFFF', // White
                    }
                }
            }
        }
    </script>

    <!-- Vue.js 3 -->
    <script type="importmap">
        {
          "imports": {
            "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js",
            "firebase/app": "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"
          }
        }
    </script>
    
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .modal-enter-active, .modal-leave-active { transition: opacity 0.2s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
        
        /* Hide number spin buttons */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-light dark:bg-dark text-slate-800 dark:text-slate-200 min-h-screen font-sans transition-colors duration-300">

<div id="app" class="flex flex-col min-h-screen">
    
    <!-- Header -->
    <header class="bg-surface-light dark:bg-surface border-b border-slate-200 dark:border-slate-700 shadow-lg sticky top-0 z-40 transition-colors duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <h1 class="text-xl font-bold tracking-wide text-slate-900 dark:text-white">WeeklyPlan <span class="text-slate-500 font-normal">Admin</span></h1>
            </div>
            
            <div class="flex items-center gap-3">
                <!-- Theme Toggle -->
                <button 
                    @click="toggleTheme" 
                    class="p-2 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
                >
                    <svg v-if="isDark" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg v-else class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>

                <a href="index.html" class="px-4 py-2 rounded-md bg-slate-700 hover:bg-slate-600 text-white text-sm transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    è¿”å›è¨ˆç®—æ©Ÿ
                </a>
            </div>
        </div>
    </header>

    <!-- Content -->
    <main class="flex-grow p-4 sm:p-6 max-w-6xl mx-auto w-full relative z-0">
        
        <div class="bg-white dark:bg-surface rounded-xl border border-slate-200 dark:border-slate-700 p-4 sm:p-6 shadow-xl transition-colors duration-300">
            <h2 class="text-xl font-bold text-slate-800 dark:text-white mb-2">å•†å“èˆ‡æˆæœ¬è¨­å®š</h2>
            <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">è¨­å®šå•†å“åç¨±ã€å–®ä½ä»¥åŠè³¼è²·æˆæœ¬ã€‚ç³»çµ±å°‡è‡ªå‹•é˜²æ­¢é‡è¤‡åç¨±ã€‚</p>

            <!-- Add New (Responsive Grid) -->
            <div class="grid grid-cols-2 md:grid-cols-6 gap-4 items-end mb-8 bg-slate-50 dark:bg-dark/30 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                <div class="col-span-2 md:col-span-2">
                    <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">åç¨±</label>
                    <input v-model="newProduct.name" type="text" placeholder="ä¾‹å¦‚ï¼šé›è›‹" class="w-full bg-white dark:bg-surface border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-slate-800 dark:text-white focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary">
                </div>
                <div class="col-span-1 md:col-span-1">
                    <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">åƒ¹æ ¼ ($)</label>
                    <input v-model.number="newProduct.packPrice" type="number" step="1" placeholder="100" class="w-full bg-white dark:bg-surface border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-slate-800 dark:text-white focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary">
                </div>
                <div class="col-span-1 md:col-span-1">
                    <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">æ•¸é‡</label>
                    <input v-model.number="newProduct.packSize" type="number" step="0.01" placeholder="1" class="w-full bg-white dark:bg-surface border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-slate-800 dark:text-white focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary">
                </div>
                <div class="col-span-1 md:col-span-1">
                    <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">å–®ä½</label>
                    <input v-model="newProduct.unit" type="text" placeholder="é¡†" class="w-full bg-white dark:bg-surface border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-slate-800 dark:text-white focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary">
                </div>
                <div class="col-span-1 md:col-span-1">
                    <button @click="addProduct" type="button" :disabled="!isFormValid" class="w-full bg-primary hover:bg-violet-600 disabled:opacity-50 text-white font-medium py-2 px-4 rounded-lg transition-colors shadow-sm">
                        <span v-if="loading">...</span>
                        <span v-else>æ–°å¢</span>
                    </button>
                </div>
            </div>

            <!-- DESKTOP View: Table -->
            <div class="hidden md:block overflow-hidden rounded-lg border border-slate-200 dark:border-slate-700">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-300 uppercase font-medium">
                        <tr>
                            <th class="px-6 py-4">åç¨±</th>
                            <th class="px-6 py-4 text-center">åƒ¹æ ¼</th>
                            <th class="px-6 py-4 text-center">æ•¸é‡</th>
                            <th class="px-6 py-4 text-center">å–®ä½</th>
                            <th class="px-6 py-4 text-right">å–®åƒ¹</th>
                            <th class="px-6 py-4 text-center">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200 dark:divide-slate-700 bg-white dark:bg-transparent">
                        <tr v-for="product in products" :key="product.id" class="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                            
                            <!-- VIEW MODE (Not Editing) -->
                            <template v-if="editingId !== product.id">
                                <td class="px-6 py-3 font-medium text-slate-800 dark:text-slate-200">{{ product.name }}</td>
                                <td class="px-6 py-3 text-center text-slate-600 dark:text-slate-400">{{ product.packPrice }}</td>
                                <td class="px-6 py-3 text-center text-slate-600 dark:text-slate-400">{{ product.packSize }}</td>
                                <td class="px-6 py-3 text-center text-slate-600 dark:text-slate-400">{{ product.unit }}</td>
                                <td class="px-6 py-3 text-right font-mono text-slate-600 dark:text-slate-400">
                                    ${{ calculateUnitPrice(product).toFixed(2) }}
                                </td>
                                <td class="px-6 py-3 text-center flex justify-center gap-2">
                                    <button @click="startEdit(product)" class="px-3 py-1 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 rounded hover:bg-slate-200 dark:hover:bg-slate-600 transition">
                                        ç·¨è¼¯
                                    </button>
                                    <button @click="deleteProduct(product.id)" class="px-3 py-1 bg-red-50 dark:bg-red-900/20 text-red-500 dark:text-red-400 rounded hover:bg-red-100 dark:hover:bg-red-900/40 transition">
                                        åˆªé™¤
                                    </button>
                                </td>
                            </template>

                            <!-- EDIT MODE -->
                            <template v-else>
                                <td class="px-6 py-3">
                                    <input v-model="editForm.name" class="w-full bg-white dark:bg-dark border border-primary rounded px-2 py-1 text-slate-800 dark:text-white outline-none">
                                </td>
                                <td class="px-6 py-3 text-center">
                                    <input type="number" v-model.number="editForm.packPrice" class="w-20 text-center bg-white dark:bg-dark border border-primary rounded px-1 py-1 text-slate-800 dark:text-white outline-none">
                                </td>
                                <td class="px-6 py-3 text-center">
                                    <input type="number" v-model.number="editForm.packSize" class="w-20 text-center bg-white dark:bg-dark border border-primary rounded px-1 py-1 text-slate-800 dark:text-white outline-none">
                                </td>
                                <td class="px-6 py-3 text-center">
                                    <input v-model="editForm.unit" class="w-16 text-center bg-white dark:bg-dark border border-primary rounded px-1 py-1 text-slate-800 dark:text-white outline-none">
                                </td>
                                <td class="px-6 py-3 text-right text-slate-400">
                                    -
                                </td>
                                <td class="px-6 py-3 text-center flex justify-center gap-2">
                                    <button @click="saveEdit" class="px-3 py-1 bg-primary text-white rounded hover:bg-violet-600 transition">å„²å­˜</button>
                                    <button @click="cancelEdit" class="px-3 py-1 bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 rounded hover:bg-slate-300 dark:hover:bg-slate-600 transition">å–æ¶ˆ</button>
                                </td>
                            </template>
                        </tr>
                        <tr v-if="products.length === 0">
                            <td colspan="6" class="px-6 py-8 text-center text-slate-500">
                                å°šæœªæ–°å¢ä»»ä½•å•†å“
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- MOBILE View: Cards -->
            <div class="md:hidden space-y-4">
                <div v-for="product in products" :key="product.id" class="bg-slate-50 dark:bg-slate-800/40 border border-slate-200 dark:border-slate-700 rounded-lg p-4 shadow-sm transition-all" :class="{'ring-2 ring-primary border-transparent': editingId === product.id}">
                    
                    <!-- VIEW MODE (Mobile) -->
                    <template v-if="editingId !== product.id">
                        <div class="mb-3">
                            <label class="text-[10px] uppercase font-bold text-slate-400 dark:text-slate-500 mb-1 block">å•†å“åç¨±</label>
                            <div class="text-lg font-bold text-slate-800 dark:text-white">{{ product.name }}</div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <div>
                                <label class="text-[10px] uppercase font-bold text-slate-400 dark:text-slate-500 mb-1 block">å–®ä½</label>
                                <div class="text-center font-medium text-slate-700 dark:text-slate-300">{{ product.unit }}</div>
                            </div>
                            <div>
                                <label class="text-[10px] uppercase font-bold text-slate-400 dark:text-slate-500 mb-1 block">æ•¸é‡</label>
                                <div class="text-center font-medium text-slate-700 dark:text-slate-300">{{ product.packSize }}</div>
                            </div>
                            <div>
                                <label class="text-[10px] uppercase font-bold text-slate-400 dark:text-slate-500 mb-1 block">åƒ¹æ ¼</label>
                                <div class="text-center font-medium text-slate-700 dark:text-slate-300">{{ product.packPrice }}</div>
                            </div>
                        </div>

                        <div class="flex justify-between items-center pt-3 border-t border-slate-200 dark:border-slate-700">
                            <div class="text-sm text-slate-600 dark:text-slate-400">
                                å–®åƒ¹ï¼š<span class="font-mono font-bold text-slate-800 dark:text-slate-200 text-base">${{ calculateUnitPrice(product).toFixed(2) }}</span>
                            </div>
                            <div class="flex gap-2">
                                <button @click="startEdit(product)" class="px-3 py-1.5 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 rounded text-xs font-bold">ç·¨è¼¯</button>
                                <button @click="deleteProduct(product.id)" class="px-3 py-1.5 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded text-xs font-bold">åˆªé™¤</button>
                            </div>
                        </div>
                    </template>

                    <!-- EDIT MODE (Mobile) -->
                    <template v-else>
                        <div class="mb-3">
                            <label class="text-[10px] uppercase font-bold text-primary mb-1 block">åç¨±</label>
                            <input v-model="editForm.name" class="w-full bg-white dark:bg-slate-800 border border-primary rounded px-2 py-2 text-slate-800 dark:text-white outline-none">
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <div>
                                <label class="text-[10px] uppercase font-bold text-primary mb-1 block">åƒ¹æ ¼</label>
                                <input type="number" v-model.number="editForm.packPrice" class="w-full bg-white dark:bg-slate-800 border border-primary rounded px-2 py-2 text-center text-slate-800 dark:text-white outline-none">
                            </div>
                            <div>
                                <label class="text-[10px] uppercase font-bold text-primary mb-1 block">æ•¸é‡</label>
                                <input type="number" v-model.number="editForm.packSize" class="w-full bg-white dark:bg-slate-800 border border-primary rounded px-2 py-2 text-center text-slate-800 dark:text-white outline-none">
                            </div>
                            <div>
                                <label class="text-[10px] uppercase font-bold text-primary mb-1 block">å–®ä½</label>
                                <input v-model="editForm.unit" class="w-full bg-white dark:bg-slate-800 border border-primary rounded px-2 py-2 text-center text-slate-800 dark:text-white outline-none">
                            </div>
                        </div>

                        <div class="flex justify-end gap-3 pt-2">
                            <button @click="cancelEdit" class="px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 rounded text-sm font-bold">å–æ¶ˆ</button>
                            <button @click="saveEdit" class="px-4 py-2 bg-primary text-white rounded text-sm font-bold shadow-lg shadow-primary/30">å„²å­˜è®Šæ›´</button>
                        </div>
                    </template>

                </div>

                <div v-if="products.length === 0" class="text-center py-8 text-slate-400 border border-dashed border-slate-300 dark:border-slate-700 rounded-lg">
                    å°šæœªæ–°å¢ä»»ä½•å•†å“
                </div>
            </div>
        </div>

    </main>

    <!-- Alert Modal -->
    <transition name="modal">
        <div v-if="modalState.isOpen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div @click="closeModal(false)" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
            <div class="bg-white dark:bg-surface rounded-xl border border-slate-200 dark:border-slate-600 shadow-2xl max-w-sm w-full relative z-10 p-6 transition-colors duration-300">
                <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-2">{{ modalState.type === 'alert' ? 'ğŸ”” æç¤º' : 'âš ï¸ ç¢ºèª' }}</h3>
                <p class="text-slate-600 dark:text-slate-300 mb-6">{{ modalState.message }}</p>
                <div class="flex justify-end gap-3">
                    <button v-if="modalState.type === 'confirm'" @click="closeModal(false)" class="px-4 py-2 rounded-lg text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-white">å–æ¶ˆ</button>
                    <button @click="closeModal(true)" class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-violet-600">ç¢ºå®š</button>
                </div>
            </div>
        </div>
    </transition>

</div>

<script type="module">
    import { createApp, ref, reactive, computed, onMounted } from 'vue';
    import { initializeApp } from 'firebase/app';
    import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, serverTimestamp } from 'firebase/firestore';

    // ==========================================
    // CONFIGURATION
    // ==========================================
    const firebaseConfig = {
        apiKey: "AIzaSyDYIbCdV49gV05_PDEHfBGpg8REOoZchgc",
        authDomain: "cost-calculator-74860.firebaseapp.com",
        projectId: "cost-calculator-74860",
        storageBucket: "cost-calculator-74860.firebasestorage.app",
        messagingSenderId: "1079472315078",
        appId: "1:1079472315078:web:e230b337dc3ec648bc15c7"
    };

    let db = null;
    if (firebaseConfig.apiKey) {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
    }

    // ==========================================
    // MAIN APP
    // ==========================================
    const app = createApp({
        setup() {
            const products = ref([]);
            const loading = ref(false);
            const isDark = ref(localStorage.getItem('theme') !== 'light');
            
            // Edit Mode State
            const editingId = ref(null);
            const editForm = reactive({ id: '', name: '', unit: '', packSize: 1, packPrice: 0 });

            // --- THEME LOGIC ---
            const toggleTheme = () => {
                isDark.value = !isDark.value;
                if(isDark.value) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            };

            // --- FIRESTORE ---
            onMounted(() => {
                if (!db) return;
                onSnapshot(collection(db, "products"), (snapshot) => {
                    products.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.name.localeCompare(b.name));
                });
            });

            // --- VALIDATION HELPER ---
            const checkDuplicateName = (name, excludeId = null) => {
                return products.value.some(p => {
                    if (excludeId && p.id === excludeId) return false;
                    return p.name.trim().toLowerCase() === name.trim().toLowerCase();
                });
            };

            // --- PRODUCT CRUD ---
            const newProduct = reactive({ name: '', unit: '', packSize: 1, packPrice: 0 });
            const isFormValid = computed(() => newProduct.name && newProduct.unit && newProduct.packSize > 0);
            
            const addProduct = async () => {
                if (!db || !isFormValid.value) return;
                
                // Duplicate Check
                if (checkDuplicateName(newProduct.name)) {
                    await showAlert(`éŒ¯èª¤ï¼šå•†å“åç¨±ã€Œ${newProduct.name}ã€å·²å­˜åœ¨ï¼`);
                    return;
                }

                loading.value = true;
                try {
                    await addDoc(collection(db, "products"), { 
                        name: newProduct.name.trim(), 
                        unit: newProduct.unit.trim(), 
                        packSize: newProduct.packSize,
                        packPrice: newProduct.packPrice,
                        createdAt: serverTimestamp() 
                    });
                    // Reset
                    newProduct.name = ''; 
                    newProduct.unit = '';
                    newProduct.packSize = 1;
                    newProduct.packPrice = 0;
                } catch(e) {
                    console.error(e);
                    await showAlert('æ–°å¢å¤±æ•—ï¼š' + e.message);
                }
                loading.value = false;
            };

            // --- EDIT LOGIC ---
            const startEdit = (product) => {
                editingId.value = product.id;
                // Copy data to edit form
                editForm.id = product.id;
                editForm.name = product.name;
                editForm.unit = product.unit;
                editForm.packSize = product.packSize;
                editForm.packPrice = product.packPrice;
            };

            const cancelEdit = () => {
                editingId.value = null;
            };

            const saveEdit = async () => {
                if (!editForm.name || !editForm.unit || editForm.packSize <= 0) {
                    await showAlert('æ¬„ä½è¼¸å…¥ä¸æ­£ç¢º');
                    return;
                }

                // Duplicate Check (Exclude self)
                if (checkDuplicateName(editForm.name, editForm.id)) {
                    await showAlert(`éŒ¯èª¤ï¼šå•†å“åç¨±ã€Œ${editForm.name}ã€å·²å­˜åœ¨ï¼`);
                    return;
                }

                if(db) {
                    await updateDoc(doc(db, "products", editForm.id), { 
                        name: editForm.name.trim(), 
                        unit: editForm.unit.trim(),
                        packSize: editForm.packSize,
                        packPrice: editForm.packPrice
                    });
                }
                editingId.value = null;
            };
            
            const deleteProduct = async (id) => { 
                if(db && await showConfirm('ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤å•†å“å—ï¼Ÿ')) {
                    await deleteDoc(doc(db, "products", id)); 
                }
            };

            const calculateUnitPrice = (p) => {
                if(!p.packSize || p.packSize === 0) return 0;
                return (p.packPrice || 0) / p.packSize;
            };

            // --- MODAL LOGIC ---
            const modalState = reactive({ isOpen: false, type: 'alert', message: '', resolve: null });
            const showConfirm = (message) => new Promise(r => { modalState.type='confirm'; modalState.message=message; modalState.isOpen=true; modalState.resolve=r; });
            const showAlert = (message) => new Promise(r => { modalState.type='alert'; modalState.message=message; modalState.isOpen=true; modalState.resolve=r; });
            const closeModal = (result) => { modalState.isOpen=false; if(modalState.resolve) { modalState.resolve(result); modalState.resolve=null; }};

            return {
                products, newProduct, loading, isFormValid,
                // Edit State
                editingId, editForm, startEdit, cancelEdit, saveEdit,
                addProduct, deleteProduct, calculateUnitPrice,
                modalState, closeModal, isDark, toggleTheme
            };
        }
    });

    app.mount('#app');
</script>

</body>
</html>