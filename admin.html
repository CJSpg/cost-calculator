<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“ç®¡ç†å¾Œå° - WeeklyPlan</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Init theme immediately to prevent flash
        if (localStorage.getItem('theme') === 'light') {
            document.documentElement.classList.remove('dark');
        } else {
            document.documentElement.classList.add('dark');
        }

        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#8B5CF6', // Violet 500
                        secondary: '#EC4899', // Pink 500
                        dark: '#0F172A', // Slate 900
                        surface: '#1E293B', // Slate 800
                        light: '#F8FAFC', // Slate 50
                        'surface-light': '#FFFFFF', // White
                    }
                }
            }
        }
    </script>

    <!-- Vue.js 3 -->
    <script type="importmap">
        {
          "imports": {
            "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js",
            "firebase/app": "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"
          }
        }
    </script>
    
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .modal-enter-active, .modal-leave-active { transition: opacity 0.2s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
        
        /* Hide number spin buttons */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-light dark:bg-dark text-slate-800 dark:text-slate-200 min-h-screen font-sans transition-colors duration-300">

<div id="app" class="flex flex-col min-h-screen">
    
    <!-- Header -->
    <header class="bg-surface-light dark:bg-surface border-b border-slate-200 dark:border-slate-700 shadow-lg sticky top-0 z-40 transition-colors duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <h1 class="text-xl font-bold tracking-wide text-slate-900 dark:text-white">WeeklyPlan <span class="text-slate-500 font-normal">Admin</span></h1>
            </div>
            
            <div class="flex items-center gap-3">
                <!-- Theme Toggle -->
                <button 
                    @click="toggleTheme" 
                    class="p-2 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
                >
                    <svg v-if="isDark" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg v-else class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>

                <a href="index.html" class="px-4 py-2 rounded-md bg-slate-700 hover:bg-slate-600 text-white text-sm transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    è¿”å›è¨ˆç®—æ©Ÿ
                </a>
            </div>
        </div>
    </header>

    <!-- Content -->
    <main class="flex-grow p-4 sm:p-6 max-w-7xl mx-auto w-full relative z-0">
        
        <div class="bg-white dark:bg-surface rounded-xl border border-slate-200 dark:border-slate-700 p-4 sm:p-6 shadow-xl transition-colors duration-300">
            
            <!-- TABS -->
            <div class="flex border-b border-slate-200 dark:border-slate-700 mb-6">
                <button 
                    @click="currentTab = 'products'" 
                    :class="['px-6 py-3 font-bold text-sm border-b-2 transition-colors flex items-center gap-2', currentTab === 'products' ? 'border-primary text-primary' : 'border-transparent text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200']"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
                    å•†å“ç®¡ç†
                </button>
                <button 
                    @click="currentTab = 'plans'; fetchPlans()" 
                    :class="['px-6 py-3 font-bold text-sm border-b-2 transition-colors flex items-center gap-2', currentTab === 'plans' ? 'border-primary text-primary' : 'border-transparent text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200']"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                    è¨ˆç•«èˆ‡æ¨¡æ¿
                </button>
            </div>

            <!-- ================= TAB 1: PRODUCTS ================= -->
            <div v-show="currentTab === 'products'">
                <h2 class="text-xl font-bold text-slate-800 dark:text-white mb-2">å•†å“èˆ‡æˆæœ¬è¨­å®š</h2>
                <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">è¨­å®šå•†å“åç¨±ã€å–®ä½ä»¥åŠè³¼è²·æˆæœ¬ã€‚ç³»çµ±å°‡è‡ªå‹•é˜²æ­¢é‡è¤‡åç¨±ã€‚</p>

                <!-- Add New Product Form -->
                <div class="grid grid-cols-2 md:grid-cols-12 gap-4 items-end mb-8 bg-slate-50 dark:bg-dark/30 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                    <div class="col-span-2 md:col-span-3">
                        <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">å•†å“åç¨±</label>
                        <input v-model="newProduct.name" type="text" placeholder="ä¾‹å¦‚ï¼šé­šæ²¹è† å›Š" class="w-full bg-white dark:bg-surface border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-slate-800 dark:text-white focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary">
                    </div>
                    
                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">æ¡è³¼å–®ä½</label>
                        <input v-model="newProduct.packageUnit" type="text" placeholder="ä¾‹å¦‚ï¼šç½" class="w-full bg-white dark:bg-surface border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-slate-800 dark:text-white focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary">
                    </div>

                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">æ¡è³¼åƒ¹æ ¼ ($)</label>
                        <input v-model.number="newProduct.packPrice" type="number" step="1" placeholder="1590" class="w-full bg-white dark:bg-surface border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-slate-800 dark:text-white focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary">
                    </div>
                    
                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">åŒ…è£å®¹é‡</label>
                        <input v-model.number="newProduct.packSize" type="number" step="0.01" placeholder="60" class="w-full bg-white dark:bg-surface border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-slate-800 dark:text-white focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary">
                    </div>
                    
                    <div class="col-span-1 md:col-span-1">
                        <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">æ¶ˆè€—å–®ä½</label>
                        <input v-model="newProduct.unit" type="text" placeholder="é¡†" class="w-full bg-white dark:bg-surface border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-slate-800 dark:text-white focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary">
                    </div>

                    <div class="col-span-2 md:col-span-2">
                        <button @click="addProduct" type="button" :disabled="!isFormValid" class="w-full bg-primary hover:bg-violet-600 disabled:opacity-50 text-white font-medium py-2 px-4 rounded-lg transition-colors shadow-sm">
                            <span v-if="loading">...</span>
                            <span v-else>æ–°å¢</span>
                        </button>
                    </div>
                </div>

                <!-- Product Table -->
                <div class="hidden md:block overflow-hidden rounded-lg border border-slate-200 dark:border-slate-700">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-300 uppercase font-medium">
                            <tr>
                                <th class="px-6 py-4">åç¨±</th>
                                <th class="px-4 py-4 text-center">æ¡è³¼å–®ä½</th>
                                <th class="px-4 py-4 text-center">åƒ¹æ ¼</th>
                                <th class="px-4 py-4 text-center">å®¹é‡</th>
                                <th class="px-4 py-4 text-center">æ¶ˆè€—å–®ä½</th>
                                <th class="px-6 py-4 text-right">æ›ç®—å–®åƒ¹</th>
                                <th class="px-6 py-4 text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200 dark:divide-slate-700 bg-white dark:bg-transparent">
                            <tr v-for="product in products" :key="product.id" class="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                                <!-- View Mode -->
                                <template v-if="editingId !== product.id">
                                    <td class="px-6 py-3 font-medium text-slate-800 dark:text-slate-200">{{ product.name }}</td>
                                    <td class="px-4 py-3 text-center text-slate-600 dark:text-slate-400">{{ product.packageUnit || '-' }}</td>
                                    <td class="px-4 py-3 text-center text-slate-600 dark:text-slate-400">{{ product.packPrice }}</td>
                                    <td class="px-4 py-3 text-center text-slate-600 dark:text-slate-400">{{ product.packSize }}</td>
                                    <td class="px-4 py-3 text-center text-slate-600 dark:text-slate-400">{{ product.unit }}</td>
                                    <td class="px-6 py-3 text-right font-mono text-slate-600 dark:text-slate-400">${{ calculateUnitPrice(product).toFixed(2) }}</td>
                                    <td class="px-6 py-3 text-center flex justify-center gap-2">
                                        <button @click="startEdit(product)" class="px-3 py-1 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 rounded hover:bg-slate-200 dark:hover:bg-slate-600 transition">ç·¨è¼¯</button>
                                        <button @click="deleteProduct(product.id)" class="px-3 py-1 bg-red-50 dark:bg-red-900/20 text-red-500 dark:text-red-400 rounded hover:bg-red-100 dark:hover:bg-red-900/40 transition">åˆªé™¤</button>
                                    </td>
                                </template>
                                <!-- Edit Mode -->
                                <template v-else>
                                    <td class="px-6 py-3"><input v-model="editForm.name" class="w-full bg-white dark:bg-dark border border-primary rounded px-2 py-1 text-slate-800 dark:text-white outline-none"></td>
                                    <td class="px-4 py-3 text-center"><input v-model="editForm.packageUnit" class="w-16 text-center bg-white dark:bg-dark border border-primary rounded px-1 py-1 text-slate-800 dark:text-white outline-none"></td>
                                    <td class="px-4 py-3 text-center"><input type="number" v-model.number="editForm.packPrice" class="w-20 text-center bg-white dark:bg-dark border border-primary rounded px-1 py-1 text-slate-800 dark:text-white outline-none"></td>
                                    <td class="px-4 py-3 text-center"><input type="number" v-model.number="editForm.packSize" class="w-20 text-center bg-white dark:bg-dark border border-primary rounded px-1 py-1 text-slate-800 dark:text-white outline-none"></td>
                                    <td class="px-4 py-3 text-center"><input v-model="editForm.unit" class="w-16 text-center bg-white dark:bg-dark border border-primary rounded px-1 py-1 text-slate-800 dark:text-white outline-none"></td>
                                    <td class="px-6 py-3 text-right text-slate-400">-</td>
                                    <td class="px-6 py-3 text-center flex justify-center gap-2">
                                        <button @click="saveEdit" class="px-3 py-1 bg-primary text-white rounded hover:bg-violet-600 transition">å„²å­˜</button>
                                        <button @click="cancelEdit" class="px-3 py-1 bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 rounded hover:bg-slate-300 dark:hover:bg-slate-600 transition">å–æ¶ˆ</button>
                                    </td>
                                </template>
                            </tr>
                            <tr v-if="products.length === 0"><td colspan="7" class="px-6 py-8 text-center text-slate-500">å°šæœªæ–°å¢ä»»ä½•å•†å“</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Mobile Product List -->
                <div class="md:hidden space-y-4">
                    <div v-for="product in products" :key="product.id" class="bg-slate-50 dark:bg-slate-800/40 border border-slate-200 dark:border-slate-700 rounded-lg p-4 shadow-sm" :class="{'ring-2 ring-primary border-transparent': editingId === product.id}">
                         <template v-if="editingId !== product.id">
                            <div class="mb-3 flex justify-between items-start">
                                <div><label class="text-[10px] uppercase font-bold text-slate-400 dark:text-slate-500 mb-1 block">å•†å“åç¨±</label><div class="text-lg font-bold text-slate-800 dark:text-white">{{ product.name }}</div></div>
                                <div v-if="product.packageUnit" class="text-right"><label class="text-[10px] uppercase font-bold text-slate-400 dark:text-slate-500 mb-1 block">å–®ä½</label><div class="text-xs font-bold bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-2 py-1 rounded">{{ product.packageUnit }}</div></div>
                            </div>
                            <div class="grid grid-cols-3 gap-3 mb-4">
                                <div><label class="text-[10px] uppercase font-bold text-slate-400 dark:text-slate-500 mb-1 block">æ¶ˆè€—å–®ä½</label><div class="text-center font-medium text-slate-700 dark:text-slate-300">{{ product.unit }}</div></div>
                                <div><label class="text-[10px] uppercase font-bold text-slate-400 dark:text-slate-500 mb-1 block">å®¹é‡</label><div class="text-center font-medium text-slate-700 dark:text-slate-300">{{ product.packSize }}</div></div>
                                <div><label class="text-[10px] uppercase font-bold text-slate-400 dark:text-slate-500 mb-1 block">åƒ¹æ ¼</label><div class="text-center font-medium text-slate-700 dark:text-slate-300">{{ product.packPrice }}</div></div>
                            </div>
                            <div class="flex justify-between items-center pt-3 border-t border-slate-200 dark:border-slate-700">
                                <div class="text-sm text-slate-600 dark:text-slate-400">å–®åƒ¹ï¼š<span class="font-mono font-bold text-slate-800 dark:text-slate-200 text-base">${{ calculateUnitPrice(product).toFixed(2) }}</span></div>
                                <div class="flex gap-2">
                                    <button @click="startEdit(product)" class="px-3 py-1.5 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 rounded text-xs font-bold">ç·¨è¼¯</button>
                                    <button @click="deleteProduct(product.id)" class="px-3 py-1.5 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded text-xs font-bold">åˆªé™¤</button>
                                </div>
                            </div>
                        </template>
                        <template v-else>
                             <!-- Mobile Edit Mode (Simplified for brevity) -->
                             <div class="space-y-2">
                                <input v-model="editForm.name" class="w-full border p-2 rounded dark:bg-slate-800 dark:border-slate-600">
                                <div class="flex gap-2">
                                    <button @click="cancelEdit" class="flex-1 bg-slate-200 dark:bg-slate-700 py-2 rounded">å–æ¶ˆ</button>
                                    <button @click="saveEdit" class="flex-1 bg-primary text-white py-2 rounded">å„²å­˜</button>
                                </div>
                             </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- ================= TAB 2: PLANS (TEMPLATES) ================= -->
            <div v-show="currentTab === 'plans'">
                 <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-slate-800 dark:text-white mb-2">è¨ˆç•«èˆ‡æ¨¡æ¿ç®¡ç†</h2>
                        <p class="text-sm text-slate-500 dark:text-slate-400">ç®¡ç†ä½¿ç”¨è€…ä¸Šå‚³çš„è¨ˆç•«ï¼Œä¸¦å°‡å…¶è¨­å®šç‚ºå®˜æ–¹æ¨¡æ¿ã€‚</p>
                    </div>
                    <button @click="fetchPlans" class="p-2 bg-slate-100 dark:bg-slate-700 rounded-full hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors" title="é‡æ–°æ•´ç†">
                         <svg class="w-5 h-5 text-slate-600 dark:text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    </button>
                </div>

                <div class="overflow-x-auto rounded-lg border border-slate-200 dark:border-slate-700">
                    <table class="w-full text-left text-sm min-w-[800px]">
                        <thead class="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-300 uppercase font-medium">
                            <tr>
                                <th class="px-6 py-4">ID / æ™‚é–“</th>
                                <th class="px-4 py-4">å‚™è¨»æ‘˜è¦</th>
                                <th class="px-4 py-4 text-center">è¨­ç‚ºæ¨¡æ¿</th>
                                <th class="px-4 py-4">æ¨¡æ¿åç¨±</th>
                                <th class="px-6 py-4 text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200 dark:divide-slate-700 bg-white dark:bg-transparent">
                            <tr v-for="plan in plans" :key="plan.id" class="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors" :class="{'bg-purple-50/50 dark:bg-purple-900/10': plan.isTemplate}">
                                <td class="px-6 py-3">
                                    <div class="font-mono font-bold text-slate-700 dark:text-slate-300">{{ plan.id.substring(0,6) }}...</div>
                                    <div class="text-xs text-slate-500 dark:text-slate-500">{{ formatDate(plan.createdAt) }}</div>
                                </td>
                                <td class="px-4 py-3 max-w-xs">
                                    <div class="truncate text-slate-600 dark:text-slate-400" :title="plan.note">{{ plan.note || '(ç„¡å‚™è¨»)' }}</div>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <!-- Toggle Switch -->
                                    <label class="inline-flex items-center cursor-pointer">
                                        <input type="checkbox" class="sr-only peer" :checked="plan.isTemplate" @change="toggleTemplate(plan)">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary relative"></div>
                                    </label>
                                </td>
                                <td class="px-4 py-3">
                                    <input 
                                        type="text" 
                                        v-model="plan.templateName" 
                                        @blur="updateTemplateName(plan)"
                                        :disabled="!plan.isTemplate"
                                        placeholder="è¼¸å…¥æ¨¡æ¿åç¨±..."
                                        class="w-full bg-transparent border-b border-slate-300 dark:border-slate-600 focus:border-primary focus:outline-none py-1 text-slate-800 dark:text-white disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                    >
                                </td>
                                <td class="px-6 py-3 text-center flex justify-center gap-2">
                                    <button @click="viewPlan(plan)" class="px-3 py-1 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 rounded hover:bg-slate-200 dark:hover:bg-slate-600 transition text-xs">æŸ¥çœ‹</button>
                                    <button @click="deletePlan(plan.id)" class="px-3 py-1 bg-red-50 dark:bg-red-900/20 text-red-500 dark:text-red-400 rounded hover:bg-red-100 dark:hover:bg-red-900/40 transition text-xs">åˆªé™¤</button>
                                </td>
                            </tr>
                            <tr v-if="plans.length === 0">
                                <td colspan="5" class="px-6 py-8 text-center text-slate-500">
                                    <span v-if="plansLoading">è¼‰å…¥ä¸­...</span>
                                    <span v-else>æ²’æœ‰ä»»ä½•è¨ˆç•«è³‡æ–™</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>

    </main>

    <!-- Plan Viewer Modal -->
    <transition name="modal">
        <div v-if="viewPlanModal.isOpen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div @click="viewPlanModal.isOpen = false" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
            <div class="bg-white dark:bg-surface rounded-xl border border-slate-200 dark:border-slate-600 shadow-2xl max-w-2xl w-full relative z-10 flex flex-col max-h-[90vh]">
                <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                    <h3 class="font-bold text-lg dark:text-white">è¨ˆç•«å…§å®¹æª¢è¦–</h3>
                    <button @click="viewPlanModal.isOpen = false" class="text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="p-4 overflow-y-auto bg-slate-50 dark:bg-dark">
                    <pre class="text-xs font-mono whitespace-pre-wrap text-slate-700 dark:text-slate-300 bg-white dark:bg-surface p-4 rounded border border-slate-200 dark:border-slate-700">{{ viewPlanModal.content }}</pre>
                </div>
            </div>
        </div>
    </transition>

    <!-- Alert Modal -->
    <transition name="modal">
        <div v-if="modalState.isOpen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div @click="closeModal(false)" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
            <div class="bg-white dark:bg-surface rounded-xl border border-slate-200 dark:border-slate-600 shadow-2xl max-w-sm w-full relative z-10 p-6 transition-colors duration-300">
                <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-2">{{ modalState.type === 'alert' ? 'ğŸ”” æç¤º' : 'âš ï¸ ç¢ºèª' }}</h3>
                <p class="text-slate-600 dark:text-slate-300 mb-6">{{ modalState.message }}</p>
                <div class="flex justify-end gap-3">
                    <button v-if="modalState.type === 'confirm'" @click="closeModal(false)" class="px-4 py-2 rounded-lg text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-white">å–æ¶ˆ</button>
                    <button @click="closeModal(true)" class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-violet-600">ç¢ºå®š</button>
                </div>
            </div>
        </div>
    </transition>

</div>

<script type="module">
    import { createApp, ref, reactive, computed, onMounted } from 'vue';
    import { initializeApp } from 'firebase/app';
    import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, limit, getDocs } from 'firebase/firestore';

    // ==========================================
    // CONFIGURATION
    // ==========================================
    const firebaseConfig = {
        apiKey: "AIzaSyDYIbCdV49gV05_PDEHfBGpg8REOoZchgc",
        authDomain: "cost-calculator-74860.firebaseapp.com",
        projectId: "cost-calculator-74860",
        storageBucket: "cost-calculator-74860.firebasestorage.app",
        messagingSenderId: "1079472315078",
        appId: "1:1079472315078:web:e230b337dc3ec648bc15c7"
    };

    let db = null;
    if (firebaseConfig.apiKey) {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
    }

    // ==========================================
    // MAIN APP
    // ==========================================
    const app = createApp({
        setup() {
            const products = ref([]);
            const loading = ref(false);
            const isDark = ref(localStorage.getItem('theme') !== 'light');
            const currentTab = ref('products');

            // --- THEME LOGIC ---
            const toggleTheme = () => {
                isDark.value = !isDark.value;
                if(isDark.value) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            };

            // --- FIRESTORE PRODUCTS ---
            const editingId = ref(null);
            const editForm = reactive({ id: '', name: '', unit: '', packSize: 1, packPrice: 0, packageUnit: '' });
            
            onMounted(() => {
                if (!db) return;
                onSnapshot(collection(db, "products"), (snapshot) => {
                    products.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.name.localeCompare(b.name));
                });
            });

            // Product Helpers
            const checkDuplicateName = (name, excludeId = null) => {
                return products.value.some(p => {
                    if (excludeId && p.id === excludeId) return false;
                    return p.name.trim().toLowerCase() === name.trim().toLowerCase();
                });
            };
            const calculateUnitPrice = (p) => (!p.packSize || p.packSize === 0) ? 0 : (p.packPrice || 0) / p.packSize;

            const newProduct = reactive({ name: '', unit: '', packSize: 1, packPrice: 0, packageUnit: '' });
            const isFormValid = computed(() => newProduct.name && newProduct.unit && newProduct.packSize > 0);
            
            const addProduct = async () => {
                if (!db || !isFormValid.value) return;
                if (checkDuplicateName(newProduct.name)) { await showAlert(`éŒ¯èª¤ï¼šå•†å“åç¨±ã€Œ${newProduct.name}ã€å·²å­˜åœ¨ï¼`); return; }
                loading.value = true;
                try {
                    await addDoc(collection(db, "products"), { 
                        name: newProduct.name.trim(), 
                        unit: newProduct.unit.trim(), 
                        packSize: newProduct.packSize,
                        packPrice: newProduct.packPrice,
                        packageUnit: newProduct.packageUnit ? newProduct.packageUnit.trim() : '',
                        createdAt: serverTimestamp() 
                    });
                    newProduct.name = ''; newProduct.unit = ''; newProduct.packSize = 1; newProduct.packPrice = 0; newProduct.packageUnit = '';
                } catch(e) { console.error(e); await showAlert('æ–°å¢å¤±æ•—ï¼š' + e.message); }
                loading.value = false;
            };

            const startEdit = (product) => { editingId.value = product.id; Object.assign(editForm, product); editForm.packageUnit = product.packageUnit || ''; };
            const cancelEdit = () => { editingId.value = null; };
            const saveEdit = async () => {
                if (!editForm.name || !editForm.unit || editForm.packSize <= 0) { await showAlert('æ¬„ä½è¼¸å…¥ä¸æ­£ç¢º'); return; }
                if (checkDuplicateName(editForm.name, editForm.id)) { await showAlert(`éŒ¯èª¤ï¼šå•†å“åç¨±ã€Œ${editForm.name}ã€å·²å­˜åœ¨ï¼`); return; }
                if(db) await updateDoc(doc(db, "products", editForm.id), { 
                    name: editForm.name.trim(), unit: editForm.unit.trim(), packSize: editForm.packSize, packPrice: editForm.packPrice,
                    packageUnit: editForm.packageUnit ? editForm.packageUnit.trim() : ''
                });
                editingId.value = null;
            };
            const deleteProduct = async (id) => { if(db && await showConfirm('ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤å•†å“å—ï¼Ÿ')) await deleteDoc(doc(db, "products", id)); };


            // --- PLANS / TEMPLATES LOGIC ---
            const plans = ref([]);
            const plansLoading = ref(false);
            const viewPlanModal = reactive({ isOpen: false, content: '' });

            const fetchPlans = async () => {
                if (!db) return;
                plansLoading.value = true;
                try {
                    // Fetch recent 50 plans
                    const q = query(collection(db, "plans"), orderBy("createdAt", "desc"), limit(50));
                    const snapshot = await getDocs(q);
                    plans.value = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        // Default fields if missing
                        isTemplate: doc.data().isTemplate || false,
                        templateName: doc.data().templateName || ''
                    }));
                } catch (e) {
                    console.error(e);
                    await showAlert('ç„¡æ³•è®€å–è¨ˆç•«è³‡æ–™');
                } finally {
                    plansLoading.value = false;
                }
            };

            const toggleTemplate = async (plan) => {
                if(!db) return;
                plan.isTemplate = !plan.isTemplate; // Toggle local UI instantly
                try {
                    await updateDoc(doc(db, "plans", plan.id), { isTemplate: plan.isTemplate });
                } catch(e) {
                    console.error(e);
                    plan.isTemplate = !plan.isTemplate; // Revert on fail
                    await showAlert('æ›´æ–°å¤±æ•—');
                }
            };

            const updateTemplateName = async (plan) => {
                if(!db) return;
                try {
                    await updateDoc(doc(db, "plans", plan.id), { templateName: plan.templateName });
                } catch(e) {
                    console.error(e);
                    await showAlert('åç¨±æ›´æ–°å¤±æ•—');
                }
            };

            const deletePlan = async (id) => {
                if (await showConfirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¨ˆç•«ç´€éŒ„å—ï¼Ÿç„¡æ³•å¾©åŸã€‚')) {
                    try {
                        await deleteDoc(doc(db, "plans", id));
                        plans.value = plans.value.filter(p => p.id !== id);
                    } catch(e) {
                        await showAlert('åˆªé™¤å¤±æ•—');
                    }
                }
            };

            const viewPlan = (plan) => {
                const { data, note } = plan;
                viewPlanModal.content = JSON.stringify({ note, plan: data }, null, 2);
                viewPlanModal.isOpen = true;
            };

            const formatDate = (timestamp) => {
                if (!timestamp) return '-';
                return new Date(timestamp.seconds * 1000).toLocaleString('zh-TW');
            };

            // --- MODAL LOGIC ---
            const modalState = reactive({ isOpen: false, type: 'alert', message: '', resolve: null });
            const showConfirm = (message) => new Promise(r => { modalState.type='confirm'; modalState.message=message; modalState.isOpen=true; modalState.resolve=r; });
            const showAlert = (message) => new Promise(r => { modalState.type='alert'; modalState.message=message; modalState.isOpen=true; modalState.resolve=r; });
            const closeModal = (result) => { modalState.isOpen=false; if(modalState.resolve) { modalState.resolve(result); modalState.resolve=null; }};

            return {
                currentTab,
                products, newProduct, loading, isFormValid,
                editingId, editForm, startEdit, cancelEdit, saveEdit, addProduct, deleteProduct, calculateUnitPrice,
                modalState, closeModal, isDark, toggleTheme,
                // Plans
                plans, plansLoading, fetchPlans, toggleTemplate, updateTemplateName, deletePlan, viewPlan, viewPlanModal, formatDate
            };
        }
    });

    app.mount('#app');
</script>

</body>
</html>